#!/bin/bash

set -euo pipefail

version=36
port=2222

usage () {
    echo "USAGE: Pass version (36, 38 or medusa) + optional port number (defaults to 2222). "
    echo "E.g. ./start_container.sh 36 2223"
    exit 1
}

if [ $# -eq 0 ] || [ $# -gt 2 ]; then
    usage
fi

if [ $# -eq 2 ]; then
    port=$2
fi

case "$1" in
    "36")
        version=$1
        shift
        ;;
    "38")
        version=$1
        shift
        ;;
    "medusa")
        version=$1
        shift
        ;;
    *)
        usage
        shift
        ;;
esac

SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
source ${SCRIPT_DIR}/../${version}.versions
if [ "${1:-}" == "external" ]; then
    image="$external_image"
    shift
else
    image="$build_image"
fi

# Test authorized_keys exists
if [ ! -f "$HOME/.ssh/authorized_keys" ]; then
    echo "ERROR: $HOME/.ssh/authorized_keys doesn't exist (or isn't readable)."
    echo "ERROR: Add your public key to .ssh/authorized_keys or else you won't be able to connect to the container!"
    exit 1
fi

if [ ! -f "$HOME/.gitconfig" ]; then
    echo "ERROR: $HOME/.gitconfig doesn't exist. Set up your Git client on your headnode first!"
    exit 1
fi

map_src=${SCRIPT_DIR}/../../

CMD="ln -s /tmp/.gitconfig /home/user/.gitconfig; ln -s /tmp/.ssh /home/user/.ssh; dropbear -w -g -R -F -E -p $port"

sudo docker run -e LOCAL_USER_ID=$(id -u $USER) \
    -v $map_src:/opt/arcticc \
    -v $HOME/.ssh:/tmp/.ssh:ro \
    -v $HOME/.gitconfig:/tmp/.gitconfig \
    -v /apps/research/tools/mongo/3.4.13_el7:/opt/mongo \
    -v /apps/research/tools/:/apps/research/tools/:ro \
    -v /etc/ahl/mongo/instances.cfg:/etc/ahl/mongo/instances.cfg \
    -v /apps/research/tools/bin/withproxy:/usr/bin/withproxy \
    -v /apps/research/tools/git/git-lfs/2.3.4/git-lfs:/usr/bin/git-lfs \
    -v /scratch/data/vscode/:/scratch/data/vscode \
    -p "${port}:${port}" \
    --privileged $image bash -c "$CMD"