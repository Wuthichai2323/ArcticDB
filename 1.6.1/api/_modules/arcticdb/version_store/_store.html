<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>arcticdb.version_store._store &mdash; ArcticDB  documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            ArcticDB
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../arcticdb.html">Arctic API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../library.html">Library API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../query_builder.html">Query Builder API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ArcticDB</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">arcticdb.version_store._store</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for arcticdb.version_store._store</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Copyright 2023 Man Group Operations Limited</span>

<span class="sd">Use of this software is governed by the Business Source License 1.1 included in the file licenses/BSL.txt.</span>

<span class="sd">As of the Change Date specified in that file, in accordance with the Business Source License, use of this software will be governed by the Apache License, version 2.0.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pytz</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">attr</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">difflib</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="kn">import</span> <span class="n">datetime64</span>
<span class="kn">from</span> <span class="nn">pandas</span> <span class="kn">import</span> <span class="n">Timestamp</span><span class="p">,</span> <span class="n">to_datetime</span><span class="p">,</span> <span class="n">Timedelta</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">TYPE_CHECKING</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>

<span class="kn">from</span> <span class="nn">arcticc.pb2.descriptors_pb2</span> <span class="kn">import</span> <span class="n">TypeDescriptor</span><span class="p">,</span> <span class="n">SortedValue</span>
<span class="kn">from</span> <span class="nn">arcticc.pb2.storage_pb2</span> <span class="kn">import</span> <span class="n">LibraryConfig</span><span class="p">,</span> <span class="n">EnvironmentConfigsMap</span>
<span class="kn">from</span> <span class="nn">arcticdb.preconditions</span> <span class="kn">import</span> <span class="n">check</span>
<span class="kn">from</span> <span class="nn">arcticdb.supported_types</span> <span class="kn">import</span> <span class="n">time_types</span> <span class="k">as</span> <span class="n">supported_time_types</span>
<span class="kn">from</span> <span class="nn">arcticdb.toolbox.library_tool</span> <span class="kn">import</span> <span class="n">LibraryTool</span>
<span class="kn">from</span> <span class="nn">arcticdb.version_store.processing</span> <span class="kn">import</span> <span class="n">QueryBuilder</span>
<span class="kn">from</span> <span class="nn">arcticdb_ext.storage</span> <span class="kn">import</span> <span class="n">OpenMode</span> <span class="k">as</span> <span class="n">_OpenMode</span>
<span class="kn">from</span> <span class="nn">arcticdb.encoding_version</span> <span class="kn">import</span> <span class="n">EncodingVersion</span>
<span class="kn">from</span> <span class="nn">arcticdb_ext.storage</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">create_mem_config_resolver</span> <span class="k">as</span> <span class="n">_create_mem_config_resolver</span><span class="p">,</span>
    <span class="n">LibraryIndex</span> <span class="k">as</span> <span class="n">_LibraryIndex</span><span class="p">,</span>
    <span class="n">Library</span> <span class="k">as</span> <span class="n">_Library</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">arcticdb.version_store.read_result</span> <span class="kn">import</span> <span class="n">ReadResult</span>
<span class="kn">from</span> <span class="nn">arcticdb_ext.version_store</span> <span class="kn">import</span> <span class="n">IndexRange</span> <span class="k">as</span> <span class="n">_IndexRange</span>
<span class="kn">from</span> <span class="nn">arcticdb_ext.version_store</span> <span class="kn">import</span> <span class="n">RowRange</span> <span class="k">as</span> <span class="n">_RowRange</span>
<span class="kn">from</span> <span class="nn">arcticdb_ext.version_store</span> <span class="kn">import</span> <span class="n">HeadRange</span> <span class="k">as</span> <span class="n">_HeadRange</span>
<span class="kn">from</span> <span class="nn">arcticdb_ext.version_store</span> <span class="kn">import</span> <span class="n">TailRange</span> <span class="k">as</span> <span class="n">_TailRange</span>
<span class="kn">from</span> <span class="nn">arcticdb_ext.version_store</span> <span class="kn">import</span> <span class="n">SignedRowRange</span> <span class="k">as</span> <span class="n">_SignedRowRange</span>
<span class="kn">from</span> <span class="nn">arcticdb_ext.version_store</span> <span class="kn">import</span> <span class="n">PythonVersionStore</span> <span class="k">as</span> <span class="n">_PythonVersionStore</span>
<span class="kn">from</span> <span class="nn">arcticdb_ext.version_store</span> <span class="kn">import</span> <span class="n">PythonVersionStoreReadQuery</span> <span class="k">as</span> <span class="n">_PythonVersionStoreReadQuery</span>
<span class="kn">from</span> <span class="nn">arcticdb_ext.version_store</span> <span class="kn">import</span> <span class="n">PythonVersionStoreUpdateQuery</span> <span class="k">as</span> <span class="n">_PythonVersionStoreUpdateQuery</span>
<span class="kn">from</span> <span class="nn">arcticdb_ext.version_store</span> <span class="kn">import</span> <span class="n">PythonVersionStoreReadOptions</span> <span class="k">as</span> <span class="n">_PythonVersionStoreReadOptions</span>
<span class="kn">from</span> <span class="nn">arcticdb_ext.version_store</span> <span class="kn">import</span> <span class="n">PythonVersionStoreVersionQuery</span> <span class="k">as</span> <span class="n">_PythonVersionStoreVersionQuery</span>
<span class="kn">from</span> <span class="nn">arcticdb_ext.version_store</span> <span class="kn">import</span> <span class="n">ColumnStats</span> <span class="k">as</span> <span class="n">_ColumnStats</span>
<span class="kn">from</span> <span class="nn">arcticdb_ext.version_store</span> <span class="kn">import</span> <span class="n">StreamDescriptorMismatch</span>
<span class="kn">from</span> <span class="nn">arcticdb_ext.version_store</span> <span class="kn">import</span> <span class="n">DataError</span>
<span class="kn">from</span> <span class="nn">arcticdb.authorization.permissions</span> <span class="kn">import</span> <span class="n">OpenMode</span>
<span class="kn">from</span> <span class="nn">arcticdb.exceptions</span> <span class="kn">import</span> <span class="n">ArcticNativeNotYetImplemented</span><span class="p">,</span> <span class="n">ArcticNativeException</span>
<span class="kn">from</span> <span class="nn">arcticdb.flattener</span> <span class="kn">import</span> <span class="n">Flattener</span>
<span class="kn">from</span> <span class="nn">arcticdb.log</span> <span class="kn">import</span> <span class="n">version</span> <span class="k">as</span> <span class="n">log</span>
<span class="kn">from</span> <span class="nn">arcticdb.version_store._custom_normalizers</span> <span class="kn">import</span> <span class="n">get_custom_normalizer</span><span class="p">,</span> <span class="n">CompositeCustomNormalizer</span>
<span class="kn">from</span> <span class="nn">arcticdb.version_store._normalization</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">NPDDataFrame</span><span class="p">,</span>
    <span class="n">normalize_metadata</span><span class="p">,</span>
    <span class="n">denormalize_user_metadata</span><span class="p">,</span>
    <span class="n">denormalize_dataframe</span><span class="p">,</span>
    <span class="n">MsgPackNormalizer</span><span class="p">,</span>
    <span class="n">CompositeNormalizer</span><span class="p">,</span>
    <span class="n">FrameData</span><span class="p">,</span>
    <span class="n">_IDX_PREFIX_LEN</span><span class="p">,</span>
    <span class="n">get_timezone_from_metadata</span><span class="p">,</span>
    <span class="n">_from_tz_timestamp</span><span class="p">,</span>
    <span class="n">restrict_data_to_date_range_only</span><span class="p">,</span>
    <span class="n">normalize_dt_range_to_ts</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">arcticdb.util.memory</span> <span class="kn">import</span> <span class="n">format_bytes</span>

<span class="n">_ExtDateRangeTypes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">indexes</span><span class="o">.</span><span class="n">datetimelike</span><span class="o">.</span><span class="n">DatetimeIndexOpsMixin</span>
<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">arctic.date</span>

        <span class="n">_ExtDateRangeTypes</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">_ExtDateRangeTypes</span><span class="p">,</span> <span class="n">arctic</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">DateRange</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
        <span class="k">pass</span>

<span class="c1"># These chars are encoded by S3 and on doing a list_symbols they will show up as the encoded form eg. &amp;amp</span>
<span class="n">UNSUPPORTED_S3_CHARS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;</span><span class="se">\0</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;&amp;&quot;</span><span class="p">,</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">}</span>
<span class="n">MAX_SYMBOL_SIZE</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">8</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>


<span class="n">TimeSeriesType</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">]</span>


<span class="n">IS_WINDOWS</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;win32&quot;</span>


<span class="c1"># auto_attribs=True breaks Cython-ising this code. As a result must manually create attr.ib instances.</span>
<div class="viewcode-block" id="VersionedItem"><a class="viewcode-back" href="../../../library.html#arcticdb.VersionedItem">[docs]</a><span class="nd">@attr</span><span class="o">.</span><span class="n">s</span><span class="p">(</span><span class="n">slots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">auto_attribs</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">VersionedItem</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return value for many operations that captures the result and associated information.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    library: str</span>
<span class="sd">        Library this result relates to.</span>
<span class="sd">    symbol: str</span>
<span class="sd">        Read or modified symbol.</span>
<span class="sd">    data: Any</span>
<span class="sd">        For data retrieval (read) operations, contains the data read.</span>
<span class="sd">        For data modification operations, the value might not be populated.</span>
<span class="sd">    version: int</span>
<span class="sd">        For data retrieval operations, the version the `as_of` argument resolved to.</span>
<span class="sd">        For data modification operations, the version the data has been written under.</span>
<span class="sd">    metadata: Any</span>
<span class="sd">        The metadata saved alongside `data`.</span>
<span class="sd">        Availability depends on the method used and may be different from that of `data`.</span>
<span class="sd">    host: Optional[str]</span>
<span class="sd">        Informational / for backwards compatibility.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">()</span>
    <span class="n">library</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">()</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="nb">repr</span><span class="o">=</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="s2">&quot;n/a&quot;</span> <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">d</span><span class="p">)))</span>
    <span class="n">version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">()</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">host</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">ib</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>  <span class="c1"># Backwards compatible with the old NamedTuple implementation</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Don&#39;t iterate VersionedItem. Use attrs.astuple() explicitly&quot;</span><span class="p">,</span> <span class="ne">SyntaxWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">iter</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">astuple</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span></div>


<span class="k">def</span> <span class="nf">_env_config_from_lib_config</span><span class="p">(</span><span class="n">lib_cfg</span><span class="p">,</span> <span class="n">env</span><span class="p">):</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">EnvironmentConfigsMap</span><span class="p">()</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">env_by_id</span><span class="p">[</span><span class="n">env</span><span class="p">]</span>
    <span class="n">e</span><span class="o">.</span><span class="n">lib_by_path</span><span class="p">[</span><span class="n">lib_cfg</span><span class="o">.</span><span class="n">lib_desc</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">CopyFrom</span><span class="p">(</span><span class="n">lib_cfg</span><span class="o">.</span><span class="n">lib_desc</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">sid</span> <span class="ow">in</span> <span class="n">lib_cfg</span><span class="o">.</span><span class="n">lib_desc</span><span class="o">.</span><span class="n">storage_ids</span><span class="p">:</span>
        <span class="n">e</span><span class="o">.</span><span class="n">storage_by_id</span><span class="p">[</span><span class="n">sid</span><span class="p">]</span><span class="o">.</span><span class="n">CopyFrom</span><span class="p">(</span><span class="n">lib_cfg</span><span class="o">.</span><span class="n">storage_by_id</span><span class="p">[</span><span class="n">sid</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">cfg</span>


<span class="n">ExplicitlySupportedDates</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">supported_time_types</span><span class="p">]</span>
<span class="n">VersionQueryInput</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">ExplicitlySupportedDates</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
<span class="n">DateRangeInput</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">ExplicitlySupportedDates</span><span class="p">],</span> <span class="n">_ExtDateRangeTypes</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_normalize_dt_range</span><span class="p">(</span><span class="n">dtr</span><span class="p">:</span> <span class="n">DateRangeInput</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_IndexRange</span><span class="p">:</span>
    <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">normalize_dt_range_to_ts</span><span class="p">(</span><span class="n">dtr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">_IndexRange</span><span class="p">(</span><span class="n">start</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">end</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_handle_categorical_columns</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">throw</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">)):</span>
        <span class="n">categorical_columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">column_name</span><span class="p">,</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dtypes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">dtype</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;category&quot;</span><span class="p">:</span>
                    <span class="n">categorical_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Series</span>
            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;category&quot;</span><span class="p">:</span>
                <span class="n">categorical_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">categorical_columns</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Symbol: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">DataFrame/Series contains categorical data, cannot append or update</span><span class="se">\n</span><span class="s2">Categorical&quot;</span>
                <span class="s2">&quot; columns: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">categorical_columns</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">throw</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ArcticNativeNotYetImplemented</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>


<span class="n">_BATCH_BAD_ARGS</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">_STREAM_DESCRIPTOR_SPLIT</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;(?&lt;=&gt;), &quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_check_batch_kwargs</span><span class="p">(</span><span class="n">batch_fun</span><span class="p">,</span> <span class="n">non_batch_fun</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
    <span class="n">cached</span> <span class="o">=</span> <span class="n">_BATCH_BAD_ARGS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">batch_fun</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cached</span><span class="p">:</span>
        <span class="n">batch_args</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">batch_fun</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">[:</span> <span class="n">batch_fun</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_argcount</span><span class="p">])</span>
        <span class="n">none_args</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">non_batch_fun</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">[:</span> <span class="n">non_batch_fun</span><span class="o">.</span><span class="vm">__code__</span><span class="o">.</span><span class="n">co_argcount</span><span class="p">])</span>
        <span class="n">cached</span> <span class="o">=</span> <span class="n">_BATCH_BAD_ARGS</span><span class="p">[</span><span class="n">batch_fun</span><span class="p">]</span> <span class="o">=</span> <span class="n">none_args</span> <span class="o">-</span> <span class="n">batch_args</span>
    <span class="n">union</span> <span class="o">=</span> <span class="n">cached</span> <span class="o">&amp;</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">union</span><span class="p">:</span>
        <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Using non-batch arguments </span><span class="si">{}</span><span class="s2"> with </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">union</span><span class="p">,</span> <span class="n">batch_fun</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">_diff_long_stream_descriptor_mismatch</span><span class="p">(</span><span class="n">nvs</span><span class="p">):</span>  <span class="c1"># Diffing strings is easier done in Python than C++</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">except</span> <span class="n">StreamDescriptorMismatch</span> <span class="k">as</span> <span class="n">sdm</span><span class="p">:</span>
        <span class="n">nvs</span><span class="o">.</span><span class="n">last_mismatch_msg</span> <span class="o">=</span> <span class="n">sdm</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">preamble</span><span class="p">,</span> <span class="n">existing</span><span class="p">,</span> <span class="n">new_val</span> <span class="o">=</span> <span class="n">sdm</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">existing</span> <span class="o">=</span> <span class="n">_STREAM_DESCRIPTOR_SPLIT</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">existing</span><span class="p">[</span><span class="n">existing</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:])</span>
        <span class="n">new_val</span> <span class="o">=</span> <span class="n">_STREAM_DESCRIPTOR_SPLIT</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">new_val</span><span class="p">[</span><span class="n">new_val</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:])</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">difflib</span><span class="o">.</span><span class="n">unified_diff</span><span class="p">(</span><span class="n">existing</span><span class="p">,</span> <span class="n">new_val</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">new_msg_lines</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">preamble</span><span class="p">,</span>
            <span class="s2">&quot;(Showing only the mismatch. Full col list saved in the `last_mismatch_msg` attribute of the lib instance.&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&#39;-&#39; marks columns missing from the argument, &#39;+&#39; for unexpected.)&quot;</span><span class="p">,</span>
            <span class="o">*</span><span class="p">(</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">islice</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;@@&quot;</span><span class="p">)),</span>
        <span class="p">)</span>
        <span class="n">sdm</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_msg_lines</span><span class="p">),)</span>
        <span class="k">raise</span>


<span class="k">def</span> <span class="nf">_assume_true</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>


<span class="k">def</span> <span class="nf">_assume_false</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>


<span class="k">class</span> <span class="nc">NativeVersionStore</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    NativeVersionStore objects provide access to ArcticDB libraries, enabling fundamental library operations</span>
<span class="sd">    such as list, reading and writing symbols (tables).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_warned_about_list_version_latest_only_and_snapshot</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">lib_cfg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">open_mode</span><span class="o">=</span><span class="n">OpenMode</span><span class="o">.</span><span class="n">DELETE</span><span class="p">):</span>
        <span class="c1"># type: (_Library, Optional[str], Optional[LibraryConfig], OpenMode)-&gt;None</span>
        <span class="n">fail_on_missing</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">fail_on_missing_custom_normalizer</span> <span class="k">if</span> <span class="n">library</span><span class="o">.</span><span class="n">config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="n">custom_normalizer</span> <span class="o">=</span> <span class="n">get_custom_normalizer</span><span class="p">(</span><span class="n">fail_on_missing</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize</span><span class="p">(</span><span class="n">library</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">lib_cfg</span><span class="p">,</span> <span class="n">custom_normalizer</span><span class="p">,</span> <span class="n">open_mode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_norm_failure_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># init normalization failure handler</span>
        <span class="n">nfh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="o">.</span><span class="n">WhichOneof</span><span class="p">(</span><span class="s2">&quot;norm_failure_handler&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">nfh</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">nfh</span> <span class="o">==</span> <span class="s2">&quot;msg_pack&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nfh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">nfh</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="p">,</span> <span class="n">nfh</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="n">use_norm_failure_handler_known_types</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span><span class="o">.</span><span class="n">use_norm_failure_handler_known_types</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">False</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_normalizer</span> <span class="o">=</span> <span class="n">CompositeNormalizer</span><span class="p">(</span>
                <span class="n">MsgPackNormalizer</span><span class="p">(</span><span class="n">nfh</span><span class="p">),</span> <span class="n">use_norm_failure_handler_known_types</span><span class="o">=</span><span class="n">use_norm_failure_handler_known_types</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ArcticNativeNotYetImplemented</span><span class="p">(</span><span class="s2">&quot;No other normalization failure handler&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">library</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">lib_cfg</span><span class="p">,</span> <span class="n">custom_normalizer</span><span class="p">,</span> <span class="n">open_mode</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_library</span> <span class="o">=</span> <span class="n">library</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cfg</span> <span class="o">=</span> <span class="n">library</span><span class="o">.</span><span class="n">config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span> <span class="o">=</span> <span class="n">_PythonVersionStore</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_library</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="n">env</span> <span class="ow">or</span> <span class="s2">&quot;local&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lib_cfg</span> <span class="o">=</span> <span class="n">lib_cfg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_custom_normalizer</span> <span class="o">=</span> <span class="n">custom_normalizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_norm_failure_handler</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_open_mode</span> <span class="o">=</span> <span class="n">open_mode</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create_store_from_lib_config</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">lib_cfg</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">open_mode</span><span class="o">=</span><span class="n">OpenMode</span><span class="o">.</span><span class="n">DELETE</span><span class="p">):</span>
        <span class="n">lib</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">create_lib_from_lib_config</span><span class="p">(</span><span class="n">lib_cfg</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">open_mode</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">library</span><span class="o">=</span><span class="n">lib</span><span class="p">,</span> <span class="n">lib_cfg</span><span class="o">=</span><span class="n">lib_cfg</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span> <span class="n">open_mode</span><span class="o">=</span><span class="n">open_mode</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create_store_from_config</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">lib_name</span><span class="p">,</span> <span class="n">open_mode</span><span class="o">=</span><span class="n">OpenMode</span><span class="o">.</span><span class="n">DELETE</span><span class="p">,</span> <span class="n">encoding_version</span><span class="o">=</span><span class="n">EncodingVersion</span><span class="o">.</span><span class="n">V1</span>
    <span class="p">):</span>
        <span class="kn">from</span> <span class="nn">arcticdb.version_store.helper</span> <span class="kn">import</span> <span class="n">extract_lib_config</span>

        <span class="n">lib_cfg</span> <span class="o">=</span> <span class="n">extract_lib_config</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">env_by_id</span><span class="p">[</span><span class="n">env</span><span class="p">],</span> <span class="n">lib_name</span><span class="p">)</span>
        <span class="n">lib_cfg</span><span class="o">.</span><span class="n">lib_desc</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">encoding_version</span> <span class="o">=</span> <span class="n">encoding_version</span>
        <span class="n">lib</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">create_lib_from_lib_config</span><span class="p">(</span><span class="n">lib_cfg</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">open_mode</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">library</span><span class="o">=</span><span class="n">lib</span><span class="p">,</span> <span class="n">lib_cfg</span><span class="o">=</span><span class="n">lib_cfg</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span> <span class="n">open_mode</span><span class="o">=</span><span class="n">open_mode</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">create_lib_from_lib_config</span><span class="p">(</span><span class="n">lib_cfg</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">open_mode</span><span class="p">):</span>
        <span class="n">envs_cfg</span> <span class="o">=</span> <span class="n">_env_config_from_lib_config</span><span class="p">(</span><span class="n">lib_cfg</span><span class="p">,</span> <span class="n">env</span><span class="p">)</span>
        <span class="n">cfg_resolver</span> <span class="o">=</span> <span class="n">_create_mem_config_resolver</span><span class="p">(</span><span class="n">envs_cfg</span><span class="p">)</span>
        <span class="n">lib_idx</span> <span class="o">=</span> <span class="n">_LibraryIndex</span><span class="o">.</span><span class="n">create_from_resolver</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">cfg_resolver</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lib_idx</span><span class="o">.</span><span class="n">get_library</span><span class="p">(</span><span class="n">lib_cfg</span><span class="o">.</span><span class="n">lib_desc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">_OpenMode</span><span class="p">(</span><span class="n">open_mode</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">create_lib_from_config</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">lib_name</span><span class="p">):</span>
        <span class="n">cfg_resolver</span> <span class="o">=</span> <span class="n">_create_mem_config_resolver</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
        <span class="n">lib_idx</span> <span class="o">=</span> <span class="n">_LibraryIndex</span><span class="o">.</span><span class="n">create_from_resolver</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">cfg_resolver</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lib_idx</span><span class="o">.</span><span class="n">get_library</span><span class="p">(</span><span class="n">lib_name</span><span class="p">,</span> <span class="n">_OpenMode</span><span class="p">(</span><span class="n">OpenMode</span><span class="o">.</span><span class="n">DELETE</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="n">lib_cfg</span> <span class="o">=</span> <span class="n">LibraryConfig</span><span class="p">()</span>
        <span class="n">lib_cfg</span><span class="o">.</span><span class="n">ParseFromString</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;lib_cfg&quot;</span><span class="p">])</span>
        <span class="n">custom_norm</span> <span class="o">=</span> <span class="n">CompositeCustomNormalizer</span><span class="p">([],</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">custom_norm</span><span class="o">.</span><span class="n">__setstate__</span><span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="s2">&quot;custom_norm&quot;</span><span class="p">])</span>
        <span class="n">env</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;env&quot;</span><span class="p">]</span>
        <span class="n">open_mode</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s2">&quot;open_mode&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize</span><span class="p">(</span>
            <span class="n">library</span><span class="o">=</span><span class="n">NativeVersionStore</span><span class="o">.</span><span class="n">create_lib_from_lib_config</span><span class="p">(</span><span class="n">lib_cfg</span><span class="p">,</span> <span class="n">env</span><span class="p">,</span> <span class="n">open_mode</span><span class="p">),</span>
            <span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">,</span>
            <span class="n">lib_cfg</span><span class="o">=</span><span class="n">lib_cfg</span><span class="p">,</span>
            <span class="n">custom_normalizer</span><span class="o">=</span><span class="n">custom_norm</span><span class="p">,</span>
            <span class="n">open_mode</span><span class="o">=</span><span class="n">open_mode</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;env&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span>
            <span class="s2">&quot;lib_cfg&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lib_cfg</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">(),</span>
            <span class="s2">&quot;custom_norm&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_custom_normalizer</span><span class="o">.</span><span class="n">__getstate__</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_custom_normalizer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;open_mode&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_mode</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__str__</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: Library: </span><span class="si">{}</span><span class="s2">, Primary Storage: </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lib_cfg</span><span class="o">.</span><span class="n">lib_desc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_backing_store</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_backing_store</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">backing_store</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">primary_backing_url</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_lib_cfg</span><span class="o">.</span><span class="n">storage_by_id</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">type_url</span>
            <span class="n">storage_val</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;cxx.arctic.org/arcticc.pb2.(.*)_pb2.Config&quot;</span><span class="p">,</span> <span class="n">primary_backing_url</span><span class="p">)</span>
            <span class="n">backing_store</span> <span class="o">=</span> <span class="n">storage_val</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Could not get primary backing store for lib due to: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">backing_store</span>

    <span class="k">def</span> <span class="nf">_try_normalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">pickle_on_failure</span><span class="p">,</span> <span class="n">dynamic_strings</span><span class="p">,</span> <span class="n">coerce_columns</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">dynamic_schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_defaults</span><span class="p">(</span>
            <span class="s2">&quot;dynamic_schema&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lib_cfg</span><span class="o">.</span><span class="n">lib_desc</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">write_options</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">udm</span> <span class="o">=</span> <span class="n">normalize_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span> <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">opt_custom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_custom_normalizer</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">dataframe</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">opt_custom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">item</span><span class="p">,</span> <span class="n">custom_norm_meta</span> <span class="o">=</span> <span class="n">opt_custom</span>
                <span class="n">item</span><span class="p">,</span> <span class="n">norm_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalizer</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="n">norm_meta</span><span class="o">.</span><span class="n">custom</span><span class="o">.</span><span class="n">CopyFrom</span><span class="p">(</span><span class="n">custom_norm_meta</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># TODO: just for pandas dataframes for now.</span>
                <span class="n">item</span><span class="p">,</span> <span class="n">norm_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalizer</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span>
                    <span class="n">dataframe</span><span class="p">,</span>
                    <span class="n">pickle_on_failure</span><span class="o">=</span><span class="n">pickle_on_failure</span><span class="p">,</span>
                    <span class="n">dynamic_strings</span><span class="o">=</span><span class="n">dynamic_strings</span><span class="p">,</span>
                    <span class="n">coerce_columns</span><span class="o">=</span><span class="n">coerce_columns</span><span class="p">,</span>
                    <span class="n">dynamic_schema</span><span class="o">=</span><span class="n">dynamic_schema</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="n">ArcticNativeNotYetImplemented</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Not supported: normalizing symbol=</span><span class="si">{}</span><span class="s2">, data=</span><span class="si">{}</span><span class="s2">, metadata=</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Error while normalizing symbol=</span><span class="si">{}</span><span class="s2">, data=</span><span class="si">{}</span><span class="s2">, metadata=</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">ex</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">ArcticNativeException</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">norm_meta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ArcticNativeException</span><span class="p">(</span><span class="s2">&quot;Cannot normalize input </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">symbol</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">udm</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">norm_meta</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">check_symbol_validity</span><span class="p">(</span><span class="n">symbol</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">MAX_SYMBOL_SIZE</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ArcticNativeNotYetImplemented</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Symbol length </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span><span class="si">}</span><span class="s2"> chars exceeds the max supported length of </span><span class="si">{</span><span class="n">MAX_SYMBOL_SIZE</span><span class="si">}</span><span class="s2"> chars.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">UNSUPPORTED_S3_CHARS</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">ArcticNativeNotYetImplemented</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The symbol &#39;</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">&#39; has one or more unsupported characters(</span><span class="si">{</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">UNSUPPORTED_S3_CHARS</span><span class="p">)</span><span class="si">}</span><span class="s2">).&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">try_flatten_and_write_composite_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">pickle_on_failure</span><span class="p">,</span> <span class="n">dynamic_strings</span><span class="p">):</span>
        <span class="n">fl</span> <span class="o">=</span> <span class="n">Flattener</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">fl</span><span class="o">.</span><span class="n">can_flatten</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="n">metastruct</span><span class="p">,</span> <span class="n">to_write</span> <span class="o">=</span> <span class="n">fl</span><span class="o">.</span><span class="n">create_meta_structure</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">symbol</span><span class="p">)</span>
            <span class="c1"># Collect all normalized items and metadata for normalization to write.</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">norm_metas</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># No items to write can happen if the entire structure is msgpack serializable. eg: [1,2] doesn&#39;t</span>
            <span class="c1"># need to go through a multi key process as the msgpack normalizer can handle it as is.</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">to_write</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">to_write</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">norm_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_normalize</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pickle_on_failure</span><span class="p">,</span> <span class="n">dynamic_strings</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                    <span class="n">norm_metas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">norm_meta</span><span class="p">)</span>
                <span class="n">normalized_udm</span> <span class="o">=</span> <span class="n">normalize_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span> <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">normalized_metastruct</span> <span class="o">=</span> <span class="n">normalize_metadata</span><span class="p">(</span><span class="n">metastruct</span><span class="p">)</span>
                <span class="n">vit_composite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">write_versioned_composite_data</span><span class="p">(</span>
                    <span class="n">symbol</span><span class="p">,</span> <span class="n">normalized_metastruct</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">to_write</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">items</span><span class="p">,</span> <span class="n">norm_metas</span><span class="p">,</span> <span class="n">normalized_udm</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">VersionedItem</span><span class="p">(</span>
                    <span class="n">symbol</span><span class="o">=</span><span class="n">vit_composite</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
                    <span class="n">library</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_library</span><span class="o">.</span><span class="n">library_path</span><span class="p">,</span>
                    <span class="n">version</span><span class="o">=</span><span class="n">vit_composite</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
                    <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span>
                <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_write_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lib_cfg</span><span class="o">.</span><span class="n">lib_desc</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">write_options</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">resolve_defaults</span><span class="p">(</span><span class="n">param_name</span><span class="p">,</span> <span class="n">proto_cfg</span><span class="p">,</span> <span class="n">global_default</span><span class="p">,</span> <span class="n">existing_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">uppercase</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Precedence: existing_value &gt; kwargs &gt; env &gt; proto_cfg &gt; global_default</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        param_name: str</span>
<span class="sd">        proto_cfg</span>
<span class="sd">            Gets the param_name attribute of this object</span>
<span class="sd">            Most often is `self._write_options()` for the Protobuf write_options.</span>
<span class="sd">        global_default</span>
<span class="sd">            FUTURE: store this in a central location</span>
<span class="sd">        existing_value:</span>
<span class="sd">            The value already supplied to the caller</span>
<span class="sd">        uppercase</span>
<span class="sd">            If true (default), will look for `param_name.upper()` in OS environment variables; otherwise, the original</span>
<span class="sd">            case.</span>
<span class="sd">        kwargs</span>
<span class="sd">            For passing through the caller&#39;s kwargs in which we look for `param_name`</span>
<span class="sd">            *Deprecating: use `existing_value`*</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">existing_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">existing_value</span>

        <span class="n">param_value</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">param_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">param_value</span>

        <span class="n">env_name</span> <span class="o">=</span> <span class="n">param_name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="k">if</span> <span class="n">uppercase</span> <span class="k">else</span> <span class="n">param_name</span>
        <span class="n">env_value</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="n">env_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">env_value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">env_value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;f&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">config_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">proto_cfg</span><span class="p">,</span> <span class="n">param_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">config_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">config_value</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="n">global_default</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">prune_previous_version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pickle_on_failure</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">validate_index</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VersionedItem</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write `data` to the specified `symbol`. If `symbol` already exists then a new version will be created to</span>
<span class="sd">        reference the newly written data. For more information on versions see the documentation for the `read`</span>
<span class="sd">        primitive.</span>

<span class="sd">        Pandas DataFrames, Pandas Series and Numpy NDArrays will be normalised into a common structure suitable for</span>
<span class="sd">        storage. Data that cannot be normalised can be written by pickling the data, however pickled data</span>
<span class="sd">        consumes more storage space, is less performant for reads and writes and does not support advanced query</span>
<span class="sd">        features. Pickling is therefore only supported via the `pickle_on_failure` flag.</span>

<span class="sd">        Normalised data will be divided into segments that are deduplicated against storage prior to write. As a result,</span>
<span class="sd">        if `data` contains only slight changes compared to pre-existing versions only the delta will be written.</span>

<span class="sd">        Note that `write` is not designed for multiple concurrent writers over a single symbol.</span>

<span class="sd">        Note: ArcticDB will use the 0-th level index of the Pandas DataFrame for its on-disk index.</span>

<span class="sd">        Any non-`DatetimeIndex` will converted into an internal `RowCount` index. That is, ArcticDB will assign each</span>
<span class="sd">        row a monotonically increasing integer identifier and that will be used for the index.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbol : `str`</span>
<span class="sd">            Symbol name. Limited to 255 characters. The following characters are not supported in symbols:</span>
<span class="sd">            &quot;*&quot;, &quot;&amp;&quot;, &quot;&lt;&quot;, &quot;&gt;&quot;</span>
<span class="sd">        data : `Union[pd.DataFrame, pd.Series, np.array]`</span>
<span class="sd">            Data to be written.</span>
<span class="sd">        metadata : `Optional[Any]`, default=None</span>
<span class="sd">            Optional metadata to persist along with the symbol.</span>
<span class="sd">        prune_previous_version : `bool`, default=True</span>
<span class="sd">            Removes previous (non-snapshotted) versions from the database.</span>
<span class="sd">        pickle_on_failure: `bool`, default=False</span>
<span class="sd">            Pickle `data` if it can&#39;t be normalized.</span>
<span class="sd">        validate_index: bool, default=False</span>
<span class="sd">            If True, will verify that the index of `data` supports date range searches and update operations. This in effect tests that the data is sorted in ascending order.</span>
<span class="sd">            ArcticDB relies on Pandas to detect if data is sorted - you can call DataFrame.index.is_monotonic_increasing on your input DataFrame to see if Pandas believes the</span>
<span class="sd">            data to be sorted</span>
<span class="sd">        kwargs :</span>
<span class="sd">            passed through to the write handler</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Optional[VersionedItem]</span>
<span class="sd">            Structure containing metadata and version number of the written symbol in the store.</span>
<span class="sd">            The data attribute will not be populated.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        UnsortedDataException</span>
<span class="sd">            If data is unsorted, when validate_index is set to True.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; df = pd.DataFrame({&#39;column&#39;: [5,6,7]})</span>
<span class="sd">        &gt;&gt;&gt; lib.write(&quot;symbol&quot;, df, metadata={&#39;my_dictionary&#39;: &#39;is_great&#39;})</span>
<span class="sd">        &gt;&gt;&gt; lib.read(&quot;symbol&quot;).data</span>
<span class="sd">           column</span>
<span class="sd">        0       5</span>
<span class="sd">        1       6</span>
<span class="sd">        2       7</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_symbol_validity</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="n">proto_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lib_cfg</span><span class="o">.</span><span class="n">lib_desc</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">write_options</span>

        <span class="n">dynamic_strings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_dynamic_strings</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">pickle_on_failure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_defaults</span><span class="p">(</span>
            <span class="s2">&quot;pickle_on_failure&quot;</span><span class="p">,</span> <span class="n">proto_cfg</span><span class="p">,</span> <span class="n">global_default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">existing_value</span><span class="o">=</span><span class="n">pickle_on_failure</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="n">prune_previous_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_defaults</span><span class="p">(</span>
            <span class="s2">&quot;prune_previous_version&quot;</span><span class="p">,</span> <span class="n">proto_cfg</span><span class="p">,</span> <span class="n">global_default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">existing_value</span><span class="o">=</span><span class="n">prune_previous_version</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="n">recursive_normalizers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_defaults</span><span class="p">(</span>
            <span class="s2">&quot;recursive_normalizers&quot;</span><span class="p">,</span> <span class="n">proto_cfg</span><span class="p">,</span> <span class="n">global_default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">uppercase</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="n">parallel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_defaults</span><span class="p">(</span><span class="s2">&quot;parallel&quot;</span><span class="p">,</span> <span class="n">proto_cfg</span><span class="p">,</span> <span class="n">global_default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">uppercase</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">incomplete</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_defaults</span><span class="p">(</span><span class="s2">&quot;incomplete&quot;</span><span class="p">,</span> <span class="n">proto_cfg</span><span class="p">,</span> <span class="n">global_default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">uppercase</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># TODO remove me when dynamic strings is the default everywhere</span>
        <span class="k">if</span> <span class="n">parallel</span><span class="p">:</span>
            <span class="n">dynamic_strings</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">coerce_columns</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;coerce_columns&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">sparsify_floats</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sparsify_floats&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">_handle_categorical_columns</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Writing with pickle_on_failure=</span><span class="si">{}</span><span class="s2">, prune_previous_version=</span><span class="si">{}</span><span class="s2">, recursive_normalizers=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">pickle_on_failure</span><span class="p">,</span>
            <span class="n">prune_previous_version</span><span class="p">,</span>
            <span class="n">recursive_normalizers</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Do a multi_key write if the structured is nested and is not trivially normalizable via msgpack.</span>
        <span class="k">if</span> <span class="n">recursive_normalizers</span><span class="p">:</span>
            <span class="n">vit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">try_flatten_and_write_composite_object</span><span class="p">(</span>
                <span class="n">symbol</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">pickle_on_failure</span><span class="p">,</span> <span class="n">dynamic_strings</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">vit</span><span class="p">,</span> <span class="n">VersionedItem</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">vit</span>

        <span class="n">udm</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">norm_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_normalize</span><span class="p">(</span>
            <span class="n">symbol</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">pickle_on_failure</span><span class="p">,</span> <span class="n">dynamic_strings</span><span class="p">,</span> <span class="n">coerce_columns</span>
        <span class="p">)</span>
        <span class="c1"># TODO: allow_sparse for write_parallel / recursive normalizers as well.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">NPDDataFrame</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">parallel</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">write_parallel</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">norm_meta</span><span class="p">,</span> <span class="n">udm</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="n">incomplete</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">append_incomplete</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">norm_meta</span><span class="p">,</span> <span class="n">udm</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">write_versioned_dataframe</span><span class="p">(</span>
                    <span class="n">symbol</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">norm_meta</span><span class="p">,</span> <span class="n">udm</span><span class="p">,</span> <span class="n">prune_previous_version</span><span class="p">,</span> <span class="n">sparsify_floats</span><span class="p">,</span> <span class="n">validate_index</span>
                <span class="p">)</span>

            <span class="k">return</span> <span class="n">VersionedItem</span><span class="p">(</span>
                <span class="n">symbol</span><span class="o">=</span><span class="n">vit</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
                <span class="n">library</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_library</span><span class="o">.</span><span class="n">library_path</span><span class="p">,</span>
                <span class="n">version</span><span class="o">=</span><span class="n">vit</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_resolve_dynamic_strings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="n">proto_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lib_cfg</span><span class="o">.</span><span class="n">lib_desc</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">write_options</span>
        <span class="k">if</span> <span class="n">IS_WINDOWS</span><span class="p">:</span>
            <span class="c1"># Fixed size strings not implemented yet for Windows as Py_UNICODE_SIZE is 2 whereas on Linux it is 4</span>
            <span class="n">normal_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_defaults</span><span class="p">(</span><span class="s2">&quot;dynamic_strings&quot;</span><span class="p">,</span> <span class="n">proto_cfg</span><span class="p">,</span> <span class="n">global_default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">normal_value</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;Windows only supports dynamic_strings=True, using dynamic strings despite configuration or kwarg&quot;</span>
                <span class="p">)</span>
            <span class="n">dynamic_strings</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dynamic_strings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_defaults</span><span class="p">(</span><span class="s2">&quot;dynamic_strings&quot;</span><span class="p">,</span> <span class="n">proto_cfg</span><span class="p">,</span> <span class="n">global_default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dynamic_strings</span>

    <span class="n">last_mismatch_msg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">dataframe</span><span class="p">:</span> <span class="n">TimeSeriesType</span><span class="p">,</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">incomplete</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">prune_previous_version</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">validate_index</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VersionedItem</span><span class="p">]:</span>
        <span class="c1"># FUTURE: use @overload and Literal for the existence of the return value once we ditch Python 3.6</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Appends the given data to the existing, stored data. Appends always appends along the index. A new version will</span>
<span class="sd">        be created to reference the newly-appended data. Append only accepts data for which the index of the first row</span>
<span class="sd">        is equal to or greater than the index of the last row in the existing data.</span>

<span class="sd">        Appends containing differing column sets to the existing data are only possible if the library has been</span>
<span class="sd">        configured to support dynamic schema.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbol : `str`</span>
<span class="sd">            Symbol name.</span>
<span class="sd">        dataframe : `TimeSeriesType`</span>
<span class="sd">            Data to be appended.</span>
<span class="sd">        metadata : `Optional[Any]`, default=None</span>
<span class="sd">            Optional metadata to persist along with the new symbol version. Note that the metadata is</span>
<span class="sd">            not combined in any way with the metadata stored in the previous version.</span>
<span class="sd">        prune_previous_version</span>
<span class="sd">            Removes previous (non-snapshotted) versions from the database.</span>
<span class="sd">        validate_index: bool, default=False</span>
<span class="sd">            If True, will verify that resulting symbol will support date range searches and update operations. This in effect tests that the previous version of the</span>
<span class="sd">            data and `data` are both sorted in ascending order. ArcticDB relies on Pandas to detect if data is sorted - you can call DataFrame.index.is_monotonic_increasing</span>
<span class="sd">            on your input DataFrame to see if Pandas believes the data to be sorted</span>
<span class="sd">        kwargs :</span>
<span class="sd">            passed through to the write handler</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Optional[VersionedItem]</span>
<span class="sd">            Structure containing metadata and version number of the written symbol in the store.</span>
<span class="sd">            The data attribute will not be populated.</span>

<span class="sd">            Nothing is returned if `incomplete` is set because no new version will be written.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        UnsortedDataException</span>
<span class="sd">            If data is unsorted, when validate_index is set to True.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; df = pd.DataFrame({&#39;column&#39;: [1,2,3]}, index=pd.date_range(start=&#39;1/1/2018&#39;, end=&#39;1/3/2018&#39;))</span>
<span class="sd">        &gt;&gt;&gt; df</span>
<span class="sd">                    column</span>
<span class="sd">        2018-01-01       1</span>
<span class="sd">        2018-01-02       2</span>
<span class="sd">        2018-01-03       3</span>
<span class="sd">        &gt;&gt;&gt; lib.write(&quot;symbol&quot;, df)</span>
<span class="sd">        &gt;&gt;&gt; to_append_df = pd.DataFrame({&#39;column&#39;: [4,5,6]}, index=pd.date_range(start=&#39;1/4/2018&#39;, end=&#39;1/6/2018&#39;))</span>
<span class="sd">        &gt;&gt;&gt; to_append_df</span>
<span class="sd">                    column</span>
<span class="sd">        2018-01-04       4</span>
<span class="sd">        2018-01-05       5</span>
<span class="sd">        2018-01-06       6</span>
<span class="sd">        &gt;&gt;&gt; lib.append(&quot;symbol&quot;, to_append_df)</span>
<span class="sd">        &gt;&gt;&gt; lib.read(&quot;symbol&quot;).data</span>
<span class="sd">                    column</span>
<span class="sd">        2018-01-01       1</span>
<span class="sd">        2018-01-02       2</span>
<span class="sd">        2018-01-03       3</span>
<span class="sd">        2018-01-04       4</span>
<span class="sd">        2018-01-05       5</span>
<span class="sd">        2018-01-06       6</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_symbol_validity</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>

        <span class="n">dynamic_strings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_dynamic_strings</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">coerce_columns</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;coerce_columns&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">_handle_categorical_columns</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">)</span>

        <span class="n">udm</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">norm_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_normalize</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">dynamic_strings</span><span class="p">,</span> <span class="n">coerce_columns</span><span class="p">)</span>

        <span class="n">write_if_missing</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;write_if_missing&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">NPDDataFrame</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">_diff_long_stream_descriptor_mismatch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">incomplete</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">append_incomplete</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">norm_meta</span><span class="p">,</span> <span class="n">udm</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">vit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">symbol</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">norm_meta</span><span class="p">,</span> <span class="n">udm</span><span class="p">,</span> <span class="n">write_if_missing</span><span class="p">,</span> <span class="n">prune_previous_version</span><span class="p">,</span> <span class="n">validate_index</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="n">VersionedItem</span><span class="p">(</span>
                        <span class="n">symbol</span><span class="o">=</span><span class="n">vit</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
                        <span class="n">library</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_library</span><span class="o">.</span><span class="n">library_path</span><span class="p">,</span>
                        <span class="n">version</span><span class="o">=</span><span class="n">vit</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
                        <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
                        <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span>
                    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">TimeSeriesType</span><span class="p">,</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">date_range</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DateRangeInput</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">upsert</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">prune_previous_version</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VersionedItem</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overwrites existing symbol data with the contents of `data`. The entire range between the first and last index</span>
<span class="sd">        entry in `data` is replaced in its entirety with the contents of `data`, adding additional index entries if</span>
<span class="sd">        required. `update` only operates over the outermost index level - this means secondary index rows will be</span>
<span class="sd">        removed if not contained in `data`.</span>

<span class="sd">        Both the existing symbol version and `data` must be timeseries-indexed.</span>

<span class="sd">        Update is idempotent.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbol: `str`</span>
<span class="sd">            Symbol name.</span>
<span class="sd">        data: `TimeSeriesType`</span>
<span class="sd">            Timeseries indexed data to use for the update.</span>
<span class="sd">        metadata: `Any`, default=None</span>
<span class="sd">            Optional metadata to persist along with the new symbol version. Note that the metadata is</span>
<span class="sd">            not combined in any way with the metadata stored in the previous version.</span>
<span class="sd">        date_range: None, or one of the types in DateRangeInput</span>
<span class="sd">            If a range is specified, it will clear/delete the data within the</span>
<span class="sd">            range and overwrite it with the data in `data`. This allows the user</span>
<span class="sd">            to update with data that might only be a subset of the</span>
<span class="sd">            original data.</span>
<span class="sd">        upsert: bool, default=False</span>
<span class="sd">            If True, will write the data even if the symbol does not exist.</span>
<span class="sd">        prune_previous_version</span>
<span class="sd">            Removes previous (non-snapshotted) versions from the database.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        VersionedItem</span>
<span class="sd">            Structure containing metadata and version number of the written symbol in the store.</span>
<span class="sd">            The data attribute will be None.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; df = pd.DataFrame({&#39;column&#39;: [1,2,3,4]}, index=pd.date_range(start=&#39;1/1/2018&#39;, end=&#39;1/4/2018&#39;))</span>
<span class="sd">        &gt;&gt;&gt; df</span>
<span class="sd">                    column</span>
<span class="sd">        2018-01-01       1</span>
<span class="sd">        2018-01-02       2</span>
<span class="sd">        2018-01-03       3</span>
<span class="sd">        2018-01-04       4</span>
<span class="sd">        &gt;&gt;&gt; lib.write(&quot;symbol&quot;, df)</span>
<span class="sd">        &gt;&gt;&gt; update_df = pd.DataFrame({&#39;column&#39;: [400, 50]}, index=pd.date_range(start=&#39;1/1/2018&#39;, end=&#39;1/3/2018&#39;, freq=&#39;2D&#39;))</span>
<span class="sd">        &gt;&gt;&gt; update_df</span>
<span class="sd">                    column</span>
<span class="sd">        2018-01-01     400</span>
<span class="sd">        2018-01-03      40</span>
<span class="sd">        &gt;&gt;&gt; lib.update(&quot;symbol&quot;, update_df)</span>
<span class="sd">        &gt;&gt;&gt; lib.read(&quot;symbol&quot;).data  # Note that 2018-01-02 is removed despite not being part of `update_df`</span>
<span class="sd">                    column</span>
<span class="sd">        2018-01-01     400</span>
<span class="sd">        2018-01-03      40</span>
<span class="sd">        2018-01-04       4</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_symbol_validity</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
        <span class="n">update_query</span> <span class="o">=</span> <span class="n">_PythonVersionStoreUpdateQuery</span><span class="p">()</span>
        <span class="n">dynamic_strings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_dynamic_strings</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">dynamic_schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_defaults</span><span class="p">(</span>
            <span class="s2">&quot;dynamic_schema&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lib_cfg</span><span class="o">.</span><span class="n">lib_desc</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">write_options</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="n">coerce_columns</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;coerce_columns&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">date_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">normalize_dt_range_to_ts</span><span class="p">(</span><span class="n">date_range</span><span class="p">)</span>
            <span class="n">update_query</span><span class="o">.</span><span class="n">row_filter</span> <span class="o">=</span> <span class="n">_IndexRange</span><span class="p">(</span><span class="n">start</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">end</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">restrict_data_to_date_range_only</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">)</span>

        <span class="n">_handle_categorical_columns</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

        <span class="n">udm</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">norm_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_normalize</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">dynamic_strings</span><span class="p">,</span> <span class="n">coerce_columns</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">NPDDataFrame</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">_diff_long_stream_descriptor_mismatch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="n">vit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="n">symbol</span><span class="p">,</span> <span class="n">update_query</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">norm_meta</span><span class="p">,</span> <span class="n">udm</span><span class="p">,</span> <span class="n">upsert</span><span class="p">,</span> <span class="n">dynamic_schema</span><span class="p">,</span> <span class="n">prune_previous_version</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">VersionedItem</span><span class="p">(</span>
                <span class="n">symbol</span><span class="o">=</span><span class="n">vit</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
                <span class="n">library</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_library</span><span class="o">.</span><span class="n">library_path</span><span class="p">,</span>
                <span class="n">version</span><span class="o">=</span><span class="n">vit</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_column_stats</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">column_stats</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">as_of</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VersionQueryInput</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the specified column statistics for each row-slice for the given symbol. In the future, these</span>
<span class="sd">        statistics will be used by `QueryBuilder` filtering operations to reduce the number of data segments read out</span>
<span class="sd">        of storage.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbol: `str`</span>
<span class="sd">            Symbol name.</span>
<span class="sd">        column_stats: `Dict[str, Set[str]]`</span>
<span class="sd">            The column stats to create.</span>
<span class="sd">            Keys are column names.</span>
<span class="sd">            Values are sets of statistic types to build for that column. Options are:</span>
<span class="sd">                &quot;MINMAX&quot; : store the minimum and maximum value for the column in each row-slice</span>
<span class="sd">        as_of : `Optional[VersionQueryInput]`, default=None</span>
<span class="sd">            See documentation of `read` method for more details.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">column_stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_column_stats</span><span class="p">(</span><span class="n">column_stats</span><span class="p">)</span>
        <span class="n">version_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_version_query</span><span class="p">(</span><span class="n">as_of</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">create_column_stats_version</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">column_stats</span><span class="p">,</span> <span class="n">version_query</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">drop_column_stats</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">column_stats</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">as_of</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VersionQueryInput</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes the specified column statistics for the given symbol.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbol: `str`</span>
<span class="sd">            Symbol name.</span>
<span class="sd">        column_stats: `Optional[Dict[str, Set[str]]], default=None`</span>
<span class="sd">            The column stats to drop. If not provided, all column stats will be dropped.</span>
<span class="sd">            See documentation of `create_column_stats` method for more details.</span>
<span class="sd">        as_of : `Optional[VersionQueryInput]`, default=None</span>
<span class="sd">            See documentation of `read` method for more details.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">column_stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_column_stats</span><span class="p">(</span><span class="n">column_stats</span><span class="p">)</span>
        <span class="n">version_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_version_query</span><span class="p">(</span><span class="n">as_of</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">drop_column_stats_version</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">column_stats</span><span class="p">,</span> <span class="n">version_query</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read_column_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">as_of</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VersionQueryInput</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read all the column statistics data that has been generated for the given symbol.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbol: `str`</span>
<span class="sd">            Symbol name.</span>
<span class="sd">        as_of : `Optional[VersionQueryInput]`, default=None</span>
<span class="sd">            See documentation of `read` method for more details.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `pandas.DataFrame`</span>
<span class="sd">            DataFrame representing the stored column statistics for each row-slice in a human-readable format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">version_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_version_query</span><span class="p">(</span><span class="n">as_of</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">denormalize_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">read_column_stats_version</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">version_query</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">get_column_stats_info</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">as_of</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VersionQueryInput</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the column statistics dictionary for the given symbol.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbol: `str`</span>
<span class="sd">            Symbol name.</span>
<span class="sd">        as_of : `Optional[VersionQueryInput]`, default=None</span>
<span class="sd">            See documentation of `read` method for more details.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `Dict[str, Set[str]]`</span>
<span class="sd">            A dict from column names to sets of column stats that have been generated for that column.</span>
<span class="sd">            In the same format as the `column_stats` argument provided to `create_column_stats` and `drop_column_stats`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">version_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_version_query</span><span class="p">(</span><span class="n">as_of</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">get_column_stats_info_version</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">version_query</span><span class="p">)</span><span class="o">.</span><span class="n">to_map</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_batch_read_keys</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">atom_keys</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">batch_read_keys</span><span class="p">(</span><span class="n">atom_keys</span><span class="p">):</span>
            <span class="n">read_result</span> <span class="o">=</span> <span class="n">ReadResult</span><span class="p">(</span><span class="o">*</span><span class="n">result</span><span class="p">)</span>
            <span class="n">vitem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adapt_read_res</span><span class="p">(</span><span class="n">read_result</span><span class="p">)</span>
            <span class="k">yield</span> <span class="n">vitem</span>

    <span class="k">def</span> <span class="nf">batch_read</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">as_ofs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">VersionQueryInput</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">date_ranges</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">DateRangeInput</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">query_builder</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">QueryBuilder</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">QueryBuilder</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">columns</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">VersionedItem</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads multiple symbols in a batch fashion. This is more efficient than making multiple `read` calls in succession</span>
<span class="sd">        as some constant-time operations can be executed only once rather than once for each element of `symbols`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbols: `List[str]`</span>
<span class="sd">            List of symbols to read</span>
<span class="sd">        as_ofs: `Optional[List[VersionQueryInput]]`, default=None</span>
<span class="sd">            List of version queries. See documentation of `read` method for more details.</span>
<span class="sd">            i-th entry corresponds to i-th element of `symbols`.</span>
<span class="sd">        date_ranges: `Optional[List[Optional[DateRangeInput]]]`, default=None</span>
<span class="sd">            List of date ranges to filter the symbols.</span>
<span class="sd">            i-th entry corresponds to i-th element of `symbols`.</span>
<span class="sd">        columns: `List[List[str]]`, default=None</span>
<span class="sd">            Which columns to return for a dataframe.</span>
<span class="sd">            i-th entry restricts columns for the i-th element in `symbols`.</span>
<span class="sd">        query_builder: `Optional[Union[QueryBuilder, List[QueryBuilder]]]`, default=None</span>
<span class="sd">            Either a single QueryBuilder object to apply to all of the dataframes before they are</span>
<span class="sd">            returned, or a list of QueryBuilder objects of the same length as the symbols list.</span>
<span class="sd">            For more information see the documentation for the QueryBuilder class.</span>
<span class="sd">            i-th entry corresponds to i-th element of `symbols`.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; lib.batch_read(</span>
<span class="sd">                [&#39;1&#39;, &#39;2&#39;, &#39;3&#39;],  # Three symbols to read in batch mode</span>
<span class="sd">                date_ranges=[</span>
<span class="sd">                    (pd.Timestamp(&#39;2000-01-01 00:00:00&#39;), pd.Timestamp(&#39;2000-02-01 00:00:00&#39;))</span>
<span class="sd">                ]*3  # Note that number of date ranges must match number of symbols</span>
<span class="sd">            )</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dict</span>
<span class="sd">            Dictionary of symbol mapping with the versioned items</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_batch_kwargs</span><span class="p">(</span><span class="n">NativeVersionStore</span><span class="o">.</span><span class="n">batch_read</span><span class="p">,</span> <span class="n">NativeVersionStore</span><span class="o">.</span><span class="n">read</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="n">throw_on_missing_version</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">versioned_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_read_to_versioned_items</span><span class="p">(</span>
            <span class="n">symbols</span><span class="p">,</span> <span class="n">as_ofs</span><span class="p">,</span> <span class="n">date_ranges</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">query_builder</span><span class="p">,</span> <span class="n">throw_on_missing_version</span><span class="p">,</span> <span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="n">check</span><span class="p">(</span>
            <span class="nb">all</span><span class="p">(</span><span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">versioned_items</span><span class="p">),</span>
            <span class="s2">&quot;Null value from _batch_read_to_versioned_items. NoDataFoundException should have been thrown instead.&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">v</span><span class="o">.</span><span class="n">symbol</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">versioned_items</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_batch_read_to_versioned_items</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">as_ofs</span><span class="p">,</span> <span class="n">date_ranges</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">query_builder</span><span class="p">,</span> <span class="n">throw_on_missing_version</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">version_queries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_version_queries</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">symbols</span><span class="p">),</span> <span class="n">as_ofs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">read_queries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_read_queries</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">symbols</span><span class="p">),</span> <span class="n">date_ranges</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">query_builder</span><span class="p">)</span>
        <span class="n">read_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_read_options</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">read_options</span><span class="o">.</span><span class="n">set_batch_throw_on_missing_version</span><span class="p">(</span><span class="n">throw_on_missing_version</span><span class="p">)</span>
        <span class="n">read_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">batch_read</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="n">version_queries</span><span class="p">,</span> <span class="n">read_queries</span><span class="p">,</span> <span class="n">read_options</span><span class="p">)</span>
        <span class="n">versioned_items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">read_results</span><span class="p">)):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">read_results</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">DataError</span><span class="p">):</span>
                <span class="n">versioned_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">read_results</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">read_result</span> <span class="o">=</span> <span class="n">ReadResult</span><span class="p">(</span><span class="o">*</span><span class="n">read_results</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">read_query</span> <span class="o">=</span> <span class="n">read_queries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">vitem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_post_process_dataframe</span><span class="p">(</span><span class="n">read_result</span><span class="p">,</span> <span class="n">read_query</span><span class="p">)</span>
                <span class="n">versioned_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vitem</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">versioned_items</span>

    <span class="k">def</span> <span class="nf">batch_read_metadata</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">as_ofs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">VersionQueryInput</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">VersionedItem</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads the metadata for multiple symbols in a batch fashion. This is more efficient than making multiple</span>
<span class="sd">        `read_metadata` calls in succession as some constant-time operations can be executed only once rather than once</span>
<span class="sd">        for each element of `symbols`.</span>
<span class="sd">        Will raise if any of the symbols do not exist.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbols: `List[str]`</span>
<span class="sd">            List of symbols to read the metadata for. Elements should not be duplicated.</span>
<span class="sd">        as_ofs: `Optional[List[VersionQueryInput]]`, default=None</span>
<span class="sd">            List of version queries. See documentation of `read` method for more details.</span>
<span class="sd">            i-th entry corresponds to i-th element of `symbols`.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; lib.batch_read_metadata(</span>
<span class="sd">                [&#39;1&#39;, &#39;2&#39;, &#39;3&#39;],  # Three symbols to read in batch mode</span>
<span class="sd">                as_ofs=[32, 33, 34]  # Note that number of as_ofs must match number of symbols</span>
<span class="sd">            )</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dict</span>
<span class="sd">            Dictionary of symbol mapping with the versioned items. The data attribute will be None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_batch_kwargs</span><span class="p">(</span><span class="n">NativeVersionStore</span><span class="o">.</span><span class="n">batch_read_metadata</span><span class="p">,</span> <span class="n">NativeVersionStore</span><span class="o">.</span><span class="n">read_metadata</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="n">meta_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_read_meta_to_versioned_items</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="n">as_ofs</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">v</span><span class="o">.</span><span class="n">symbol</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">meta_items</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_batch_read_meta_to_versioned_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">as_ofs</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">meta_data_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">version_queries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_version_queries</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">symbols</span><span class="p">),</span> <span class="n">as_ofs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">read_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_read_options</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">batch_read_metadata</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="n">version_queries</span><span class="p">,</span> <span class="n">read_options</span><span class="p">)</span>
        <span class="n">result_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="n">result</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">original_symbol</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">result_list</span><span class="p">:</span>
            <span class="n">vitem</span><span class="p">,</span> <span class="n">udm</span> <span class="o">=</span> <span class="n">result</span>
            <span class="k">if</span> <span class="n">original_symbol</span> <span class="o">!=</span> <span class="n">vitem</span><span class="o">.</span><span class="n">symbol</span><span class="p">:</span>
                <span class="n">meta_data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">meta</span> <span class="o">=</span> <span class="n">denormalize_user_metadata</span><span class="p">(</span><span class="n">udm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalizer</span><span class="p">)</span> <span class="k">if</span> <span class="n">udm</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="n">meta_data_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">VersionedItem</span><span class="p">(</span>
                        <span class="n">symbol</span><span class="o">=</span><span class="n">vitem</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
                        <span class="n">library</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_library</span><span class="o">.</span><span class="n">library_path</span><span class="p">,</span>
                        <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">version</span><span class="o">=</span><span class="n">vitem</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
                        <span class="n">metadata</span><span class="o">=</span><span class="n">meta</span><span class="p">,</span>
                        <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">meta_data_list</span>

    <span class="k">def</span> <span class="nf">batch_read_metadata_multi</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">as_ofs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">VersionQueryInput</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">VersionedItem</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads the metadata for multiple symbols in a batch fashion. This is more efficient than making multiple</span>
<span class="sd">        `read_metadata` calls in succession as some constant-time operations can be executed only once rather than once</span>
<span class="sd">        for each element of `symbols`.</span>
<span class="sd">        Will raise if any of the symbols do not exist.</span>
<span class="sd">        Behaviour is the same as batch_read_metadata, but allows the metadata for multiple versions of the same symbol</span>
<span class="sd">        to be read in one call.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbols: `List[str]`</span>
<span class="sd">            List of symbols to read the metadata for. Elements can be duplicated.</span>
<span class="sd">        as_ofs: `Optional[List[VersionQueryInput]]`, default=None</span>
<span class="sd">            List of version queries. See documentation of `read` method for more details.</span>
<span class="sd">            i-th entry corresponds to i-th element of `symbols`.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; lib.batch_read_metadata_multi(</span>
<span class="sd">                [&#39;1&#39;, &#39;1&#39;, &#39;2&#39;],  # Three symbols to read in batch mode</span>
<span class="sd">                as_ofs=[32, 33, 34]  # Note that number of as_ofs must match number of symbols</span>
<span class="sd">            )</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dict</span>
<span class="sd">            Dictionary of symbol mapped to dictionary of [int, VersionedItem], where the int represents the version for</span>
<span class="sd">            each VersionedItem for each symbol. The data attribute will be None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_batch_kwargs</span><span class="p">(</span><span class="n">NativeVersionStore</span><span class="o">.</span><span class="n">batch_read_metadata</span><span class="p">,</span> <span class="n">NativeVersionStore</span><span class="o">.</span><span class="n">read_metadata</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="n">results_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">version_queries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_version_queries</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">symbols</span><span class="p">),</span> <span class="n">as_ofs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">read_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_read_options</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">batch_read_metadata</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="n">version_queries</span><span class="p">,</span> <span class="n">read_options</span><span class="p">):</span>
            <span class="n">vitem</span><span class="p">,</span> <span class="n">udm</span> <span class="o">=</span> <span class="n">result</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="n">denormalize_user_metadata</span><span class="p">(</span><span class="n">udm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalizer</span><span class="p">)</span> <span class="k">if</span> <span class="n">udm</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">vitem</span><span class="o">.</span><span class="n">symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">results_dict</span><span class="p">:</span>
                <span class="n">results_dict</span><span class="p">[</span><span class="n">vitem</span><span class="o">.</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">results_dict</span><span class="p">[</span><span class="n">vitem</span><span class="o">.</span><span class="n">symbol</span><span class="p">][</span><span class="n">vitem</span><span class="o">.</span><span class="n">version</span><span class="p">]</span> <span class="o">=</span> <span class="n">VersionedItem</span><span class="p">(</span>
                <span class="n">symbol</span><span class="o">=</span><span class="n">vitem</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
                <span class="n">library</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_library</span><span class="o">.</span><span class="n">library_path</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">version</span><span class="o">=</span><span class="n">vitem</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="n">meta</span><span class="p">,</span>
                <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">results_dict</span>

    <span class="k">def</span> <span class="nf">_convert_thin_cxx_item_to_python</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VersionedItem</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert a cxx versioned item that does not contain data or metadata to a Python equivalent.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">VersionedItem</span><span class="p">(</span>
            <span class="n">symbol</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
            <span class="n">library</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_library</span><span class="o">.</span><span class="n">library_path</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">v</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">batch_write</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">data_vector</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
        <span class="n">metadata_vector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">prune_previous_version</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">pickle_on_failure</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">validate_index</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">VersionedItem</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write data to multiple symbols in a batch fashion. This is more efficient than making multiple `write` calls in</span>
<span class="sd">        succession as some constant-time operations can be executed only once rather than once for each element of</span>
<span class="sd">        `symbols`.</span>
<span class="sd">        Note that this isn&#39;t an atomic operation - it&#39;s possible for one symbol to be fully written and readable before</span>
<span class="sd">        another symbol.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbols : `List[str]`</span>
<span class="sd">            List of symbols to be written in batch. Elements should not be duplicated.</span>
<span class="sd">        data_vector : `List[Any]`</span>
<span class="sd">            Data to be written.</span>
<span class="sd">            i-th entry corresponds to i-th element of `symbols`.</span>
<span class="sd">        metadata_vector : `Optional[List[Any]]`, default=None</span>
<span class="sd">            Metadata to be written.</span>
<span class="sd">            i-th entry corresponds to i-th element of `symbols`.</span>
<span class="sd">        prune_previous_version : `Optional[bool]`, default=None</span>
<span class="sd">            Remove previous versions from version list. Uses library default if left as None.</span>
<span class="sd">        pickle_on_failure : `Optional[bool]`, default=None</span>
<span class="sd">            Pickle results if normalization fails. Uses library default if left as None.</span>
<span class="sd">        validate_index: bool, default=False</span>
<span class="sd">            If True, will verify for each entry in the batch hat the index of `data` supports date range searches and update operations.</span>
<span class="sd">            This in effect tests that the data is sorted in ascending order. ArcticDB relies on Pandas to detect if data is sorted -</span>
<span class="sd">            you can call DataFrame.index.is_monotonic_increasing on your input DataFrame to see if Pandas believes the data to be sorted</span>
<span class="sd">        kwargs :</span>
<span class="sd">            passed through to the write handler</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; lib.batch_write(</span>
<span class="sd">                [&#39;1&#39;, &#39;2&#39;, &#39;3&#39;],  # Three symbols to write in one call</span>
<span class="sd">                [df1, df2, df3],  # Three dataframes</span>
<span class="sd">            )</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List</span>
<span class="sd">            List of versioned items. The data attribute will be None for each versioned item.</span>
<span class="sd">            i-th entry corresponds to i-th element of `symbols`.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        UnsortedDataException</span>
<span class="sd">            If data is unsorted, when validate_index is set to True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_batch_kwargs</span><span class="p">(</span><span class="n">NativeVersionStore</span><span class="o">.</span><span class="n">batch_write</span><span class="p">,</span> <span class="n">NativeVersionStore</span><span class="o">.</span><span class="n">write</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_symbol_validity</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>

        <span class="n">proto_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lib_cfg</span><span class="o">.</span><span class="n">lib_desc</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">write_options</span>
        <span class="n">prune_previous_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_defaults</span><span class="p">(</span>
            <span class="s2">&quot;prune_previous_version&quot;</span><span class="p">,</span> <span class="n">proto_cfg</span><span class="p">,</span> <span class="n">global_default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">existing_value</span><span class="o">=</span><span class="n">prune_previous_version</span>
        <span class="p">)</span>

        <span class="n">dynamic_strings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_dynamic_strings</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">pickle_on_failure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_defaults</span><span class="p">(</span>
            <span class="s2">&quot;pickle_on_failure&quot;</span><span class="p">,</span> <span class="n">proto_cfg</span><span class="p">,</span> <span class="n">global_default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">existing_value</span><span class="o">=</span><span class="n">pickle_on_failure</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">metadata_vector</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">metadata_itr</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metadata_itr</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">metadata_vector</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">symbols</span><span class="p">)):</span>
            <span class="n">_handle_categorical_columns</span><span class="p">(</span><span class="n">symbols</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">data_vector</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="kc">False</span><span class="p">)</span>

        <span class="n">normalized_infos</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_try_normalize</span><span class="p">(</span>
                <span class="n">symbols</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                <span class="n">data_vector</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                <span class="nb">next</span><span class="p">(</span><span class="n">metadata_itr</span><span class="p">),</span>
                <span class="n">pickle_on_failure</span><span class="o">=</span><span class="n">pickle_on_failure</span><span class="p">,</span>
                <span class="n">dynamic_strings</span><span class="o">=</span><span class="n">dynamic_strings</span><span class="p">,</span>
                <span class="n">coerce_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">symbols</span><span class="p">))</span>
        <span class="p">]</span>
        <span class="n">udms</span> <span class="o">=</span> <span class="p">[</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">normalized_infos</span><span class="p">]</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">normalized_infos</span><span class="p">]</span>
        <span class="n">norm_metas</span> <span class="o">=</span> <span class="p">[</span><span class="n">info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">normalized_infos</span><span class="p">]</span>
        <span class="n">cxx_versioned_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">batch_write</span><span class="p">(</span>
            <span class="n">symbols</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">norm_metas</span><span class="p">,</span> <span class="n">udms</span><span class="p">,</span> <span class="n">prune_previous_version</span><span class="p">,</span> <span class="n">validate_index</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_convert_thin_cxx_item_to_python</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cxx_versioned_items</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">batch_write_metadata</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">metadata_vector</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">prune_previous_version</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">VersionedItem</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write metadata to multiple symbols in a batch fashion. This is more efficient than making multiple `write` calls</span>
<span class="sd">        in succession as some constant-time operations can be executed only once rather than once for each element of</span>
<span class="sd">        `symbols`.</span>
<span class="sd">        Note that this isn&#39;t an atomic operation - it&#39;s possible for the metadata for one symbol to be fully written and</span>
<span class="sd">        readable before another symbol.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbols : `List[str]`</span>
<span class="sd">            List of symbols to be written in batch. Elements should not be duplicated.</span>
<span class="sd">        metadata_vector : `List[Any]`</span>
<span class="sd">            Metadata to be written.</span>
<span class="sd">            i-th entry corresponds to i-th element of `symbols`.</span>
<span class="sd">        prune_previous_version : `Optional[bool]`, default=None</span>
<span class="sd">            Remove previous versions from version list. Uses library default if left as None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List</span>
<span class="sd">            List of versioned items. The data attribute will be None for each versioned item.</span>
<span class="sd">            i-th entry corresponds to i-th element of `symbols`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_symbol_validity</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>

        <span class="n">proto_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lib_cfg</span><span class="o">.</span><span class="n">lib_desc</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">write_options</span>
        <span class="n">prune_previous_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_defaults</span><span class="p">(</span>
            <span class="s2">&quot;prune_previous_version&quot;</span><span class="p">,</span> <span class="n">proto_cfg</span><span class="p">,</span> <span class="n">global_default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">existing_value</span><span class="o">=</span><span class="n">prune_previous_version</span>
        <span class="p">)</span>
        <span class="n">normalized_meta</span> <span class="o">=</span> <span class="p">[</span><span class="n">normalize_metadata</span><span class="p">(</span><span class="n">metadata_vector</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">symbols</span><span class="p">))]</span>

        <span class="n">cxx_versioned_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">batch_write_metadata</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="n">normalized_meta</span><span class="p">,</span> <span class="n">prune_previous_version</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_convert_thin_cxx_item_to_python</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cxx_versioned_items</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">batch_append</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">data_vector</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">TimeSeriesType</span><span class="p">],</span>
        <span class="n">metadata_vector</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">prune_previous_version</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">validate_index</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">VersionedItem</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Append data to multiple symbols in a batch fashion. This is more efficient than making multiple `append` calls in</span>
<span class="sd">        succession as some constant-time operations can be executed only once rather than once for each element of</span>
<span class="sd">        `symbols`.</span>
<span class="sd">        Note that this isn&#39;t an atomic operation - it&#39;s possible for one symbol to be fully written and readable before</span>
<span class="sd">        another symbol.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbols : `List[str]`</span>
<span class="sd">            List of symbols to be appended-to in batch. Elements should not be duplicated.</span>
<span class="sd">        data_vector : `List[TimeSeriesType]`</span>
<span class="sd">            Data to be appended.</span>
<span class="sd">            i-th entry corresponds to i-th element of `symbols`.</span>
<span class="sd">        metadata_vector : `Optional[List[Any]]`, default=None</span>
<span class="sd">            Metadata to be written. Note that the metadata is not combined in any way with the metadata stored in the</span>
<span class="sd">            previous version.</span>
<span class="sd">            i-th entry corresponds to i-th element of `symbols`.</span>
<span class="sd">        prune_previous_version : `Optional[bool]`, default=None</span>
<span class="sd">            Remove previous versions from version list. Uses library default if left as None.</span>
<span class="sd">        validate_index: bool, default=False</span>
<span class="sd">            If True, will verify for each entry in the batch hat the index of `data` supports date range searches and update operations.</span>
<span class="sd">            This in effect tests that the data is sorted in ascending order. ArcticDB relies on Pandas to detect if data is sorted -</span>
<span class="sd">            you can call DataFrame.index.is_monotonic_increasing on your input DataFrame to see if Pandas believes the data to be sorted</span>
<span class="sd">        kwargs :</span>
<span class="sd">            passed through to the write handler</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List</span>
<span class="sd">            List of versioned items. The data attribute will be None for each versioned item.</span>
<span class="sd">            i-th entry corresponds to i-th element of `symbols`.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        UnsortedDataException</span>
<span class="sd">            If data is unsorted, when validate_index is set to True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_batch_kwargs</span><span class="p">(</span><span class="n">NativeVersionStore</span><span class="o">.</span><span class="n">batch_append</span><span class="p">,</span> <span class="n">NativeVersionStore</span><span class="o">.</span><span class="n">append</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">symbols</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_symbol_validity</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>

        <span class="n">proto_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lib_cfg</span><span class="o">.</span><span class="n">lib_desc</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">write_options</span>
        <span class="n">prune_previous_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_defaults</span><span class="p">(</span>
            <span class="s2">&quot;prune_previous_version&quot;</span><span class="p">,</span> <span class="n">proto_cfg</span><span class="p">,</span> <span class="n">global_default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">existing_value</span><span class="o">=</span><span class="n">prune_previous_version</span>
        <span class="p">)</span>
        <span class="n">dynamic_strings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_dynamic_strings</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">metadata_vector</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">metadata_itr</span> <span class="o">=</span> <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">metadata_itr</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">metadata_vector</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">symbols</span><span class="p">)):</span>
            <span class="n">_handle_categorical_columns</span><span class="p">(</span><span class="n">symbols</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">data_vector</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>

        <span class="n">normalized_infos</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_try_normalize</span><span class="p">(</span>
                <span class="n">symbols</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                <span class="n">data_vector</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
                <span class="nb">next</span><span class="p">(</span><span class="n">metadata_itr</span><span class="p">),</span>
                <span class="n">dynamic_strings</span><span class="o">=</span><span class="n">dynamic_strings</span><span class="p">,</span>
                <span class="n">pickle_on_failure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">coerce_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">symbols</span><span class="p">))</span>
        <span class="p">]</span>
        <span class="n">udms</span> <span class="o">=</span> <span class="p">[</span><span class="n">info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">normalized_infos</span><span class="p">]</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[</span><span class="n">info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">normalized_infos</span><span class="p">]</span>
        <span class="n">norm_metas</span> <span class="o">=</span> <span class="p">[</span><span class="n">info</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">normalized_infos</span><span class="p">]</span>
        <span class="n">cxx_versioned_items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">batch_append</span><span class="p">(</span>
            <span class="n">symbols</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">norm_metas</span><span class="p">,</span> <span class="n">udms</span><span class="p">,</span> <span class="n">prune_previous_version</span><span class="p">,</span> <span class="n">validate_index</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_convert_thin_cxx_item_to_python</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cxx_versioned_items</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">batch_restore_version</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">as_ofs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">VersionQueryInput</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">VersionedItem</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Makes the latest version of the symbols equal to the as_of specified versions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbols : `List[str]`</span>
<span class="sd">            Symbol names.</span>
<span class="sd">        as_ofs : `Optional[List[VersionQueryInput]]`, default=None</span>
<span class="sd">            See documentation of `read` method for more details.</span>
<span class="sd">            i-th entry corresponds to i-th element of `symbols`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List[VersionedItem]</span>
<span class="sd">            Includes the version number that was just written.</span>
<span class="sd">            i-th entry corresponds to i-th element of `symbols`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_batch_kwargs</span><span class="p">(</span><span class="n">NativeVersionStore</span><span class="o">.</span><span class="n">batch_restore_version</span><span class="p">,</span> <span class="n">NativeVersionStore</span><span class="o">.</span><span class="n">restore_version</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="n">version_queries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_version_queries</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">symbols</span><span class="p">),</span> <span class="n">as_ofs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">raw_results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">batch_restore_version</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="n">version_queries</span><span class="p">)</span>
        <span class="n">read_results</span> <span class="o">=</span> <span class="p">[</span><span class="n">ReadResult</span><span class="p">(</span><span class="o">*</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">raw_results</span><span class="p">]</span>
        <span class="n">metadatas</span> <span class="o">=</span> <span class="p">[</span><span class="n">denormalize_user_metadata</span><span class="p">(</span><span class="n">read_result</span><span class="o">.</span><span class="n">udm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalizer</span><span class="p">)</span> <span class="k">for</span> <span class="n">read_result</span> <span class="ow">in</span> <span class="n">read_results</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="n">VersionedItem</span><span class="p">(</span>
                <span class="n">symbol</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
                <span class="n">library</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_library</span><span class="o">.</span><span class="n">library_path</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">version</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="n">meta</span><span class="p">,</span>
                <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">result</span><span class="p">,</span> <span class="n">meta</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">read_results</span><span class="p">,</span> <span class="n">metadatas</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">_get_version_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">as_of</span><span class="p">:</span> <span class="n">VersionQueryInput</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">version_query</span> <span class="o">=</span> <span class="n">_PythonVersionStoreVersionQuery</span><span class="p">()</span>
        <span class="n">version_query</span><span class="o">.</span><span class="n">set_skip_compat</span><span class="p">(</span><span class="n">_assume_true</span><span class="p">(</span><span class="s2">&quot;skip_compat&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
        <span class="n">version_query</span><span class="o">.</span><span class="n">set_iterate_on_failure</span><span class="p">(</span><span class="n">_assume_false</span><span class="p">(</span><span class="s2">&quot;iterate_on_failure&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">as_of</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">version_query</span><span class="o">.</span><span class="n">set_snap_name</span><span class="p">(</span><span class="n">as_of</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">as_of</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">version_query</span><span class="o">.</span><span class="n">set_version</span><span class="p">(</span><span class="n">as_of</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">as_of</span><span class="p">,</span> <span class="p">(</span><span class="n">datetime</span><span class="p">,</span> <span class="n">Timestamp</span><span class="p">)):</span>
            <span class="n">version_query</span><span class="o">.</span><span class="n">set_timestamp</span><span class="p">(</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">as_of</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">as_of</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ArcticNativeException</span><span class="p">(</span><span class="s2">&quot;Unexpected combination of read parameters&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">version_query</span>

    <span class="k">def</span> <span class="nf">_get_version_queries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_symbols</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">as_ofs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">VersionQueryInput</span><span class="p">]],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">as_ofs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">check</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">as_ofs</span><span class="p">)</span> <span class="o">==</span> <span class="n">num_symbols</span><span class="p">,</span>
                <span class="s2">&quot;Mismatched number of symbols (</span><span class="si">{}</span><span class="s2">) and as_ofs (</span><span class="si">{}</span><span class="s2">) supplied to batch read&quot;</span><span class="p">,</span>
                <span class="n">num_symbols</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">as_ofs</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_version_query</span><span class="p">(</span><span class="n">as_of</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">as_of</span> <span class="ow">in</span> <span class="n">as_ofs</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_version_query</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_symbols</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">_get_read_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_range</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DateRangeInput</span><span class="p">],</span> <span class="n">row_range</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">query_builder</span><span class="p">):</span>
        <span class="n">check</span><span class="p">(</span><span class="n">date_range</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">row_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Date range and row range both specified&quot;</span><span class="p">)</span>
        <span class="n">read_query</span> <span class="o">=</span> <span class="n">_PythonVersionStoreReadQuery</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">query_builder</span><span class="p">:</span>
            <span class="n">read_query</span><span class="o">.</span><span class="n">add_clauses</span><span class="p">(</span><span class="n">query_builder</span><span class="o">.</span><span class="n">clauses</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">date_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">read_query</span><span class="o">.</span><span class="n">row_filter</span> <span class="o">=</span> <span class="n">_normalize_dt_range</span><span class="p">(</span><span class="n">date_range</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">row_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">read_query</span><span class="o">.</span><span class="n">row_range</span> <span class="o">=</span> <span class="n">row_range</span>

        <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">read_query</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">read_query</span>

    <span class="k">def</span> <span class="nf">_get_read_queries</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">num_symbols</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">date_ranges</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">DateRangeInput</span><span class="p">]]],</span>
        <span class="n">columns</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]],</span>
        <span class="n">query_builder</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">QueryBuilder</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">QueryBuilder</span><span class="p">]]],</span>
    <span class="p">):</span>
        <span class="n">read_queries</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">date_ranges</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">check</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">date_ranges</span><span class="p">)</span> <span class="o">==</span> <span class="n">num_symbols</span><span class="p">,</span>
                <span class="s2">&quot;Mismatched number of symbols (</span><span class="si">{}</span><span class="s2">) and date ranges (</span><span class="si">{}</span><span class="s2">) supplied to batch read&quot;</span><span class="p">,</span>
                <span class="n">num_symbols</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">date_ranges</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">query_builder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query_builder</span><span class="p">,</span> <span class="n">QueryBuilder</span><span class="p">):</span>
            <span class="n">check</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">query_builder</span><span class="p">)</span> <span class="o">==</span> <span class="n">num_symbols</span><span class="p">,</span>
                <span class="s2">&quot;Mismatched number of symbols (</span><span class="si">{}</span><span class="s2">) and query builders (</span><span class="si">{}</span><span class="s2">) supplied to batch read&quot;</span><span class="p">,</span>
                <span class="n">num_symbols</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">query_builder</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">check</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="n">num_symbols</span><span class="p">,</span>
                <span class="s2">&quot;Mismatched number of symbols (</span><span class="si">{}</span><span class="s2">) and columns (</span><span class="si">{}</span><span class="s2">) supplied to batch read&quot;</span><span class="p">,</span>
                <span class="n">num_symbols</span><span class="p">,</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_symbols</span><span class="p">):</span>
            <span class="n">date_range</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">these_columns</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">query</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">date_ranges</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">date_range</span> <span class="o">=</span> <span class="n">date_ranges</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">these_columns</span> <span class="o">=</span> <span class="n">columns</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">query_builder</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">query</span> <span class="o">=</span> <span class="n">query_builder</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">query_builder</span><span class="p">,</span> <span class="n">QueryBuilder</span><span class="p">)</span> <span class="k">else</span> <span class="n">query_builder</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="n">read_queries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_read_query</span><span class="p">(</span><span class="n">date_range</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">these_columns</span><span class="p">,</span> <span class="n">query</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">read_queries</span>

    <span class="k">def</span> <span class="nf">_get_read_options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">proto_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lib_cfg</span><span class="o">.</span><span class="n">lib_desc</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">write_options</span>
        <span class="n">read_options</span> <span class="o">=</span> <span class="n">_PythonVersionStoreReadOptions</span><span class="p">()</span>
        <span class="n">read_options</span><span class="o">.</span><span class="n">set_force_strings_to_object</span><span class="p">(</span><span class="n">_assume_false</span><span class="p">(</span><span class="s2">&quot;force_string_to_object&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
        <span class="n">read_options</span><span class="o">.</span><span class="n">set_optimise_string_memory</span><span class="p">(</span><span class="n">_assume_false</span><span class="p">(</span><span class="s2">&quot;optimise_string_memory&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
        <span class="n">read_options</span><span class="o">.</span><span class="n">set_dynamic_schema</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resolve_defaults</span><span class="p">(</span><span class="s2">&quot;dynamic_schema&quot;</span><span class="p">,</span> <span class="n">proto_cfg</span><span class="p">,</span> <span class="n">global_default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">read_options</span><span class="o">.</span><span class="n">set_set_tz</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resolve_defaults</span><span class="p">(</span><span class="s2">&quot;set_tz&quot;</span><span class="p">,</span> <span class="n">proto_cfg</span><span class="p">,</span> <span class="n">global_default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="n">read_options</span><span class="o">.</span><span class="n">set_allow_sparse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resolve_defaults</span><span class="p">(</span><span class="s2">&quot;allow_sparse&quot;</span><span class="p">,</span> <span class="n">proto_cfg</span><span class="p">,</span> <span class="n">global_default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="n">read_options</span><span class="o">.</span><span class="n">set_incompletes</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resolve_defaults</span><span class="p">(</span><span class="s2">&quot;incomplete&quot;</span><span class="p">,</span> <span class="n">proto_cfg</span><span class="p">,</span> <span class="n">global_default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">read_options</span>

    <span class="k">def</span> <span class="nf">_get_queries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">as_of</span><span class="p">,</span> <span class="n">date_range</span><span class="p">,</span> <span class="n">row_range</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">query_builder</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">version_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_version_query</span><span class="p">(</span><span class="n">as_of</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">read_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_read_options</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">read_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_read_query</span><span class="p">(</span><span class="n">date_range</span><span class="p">,</span> <span class="n">row_range</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">query_builder</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">version_query</span><span class="p">,</span> <span class="n">read_options</span><span class="p">,</span> <span class="n">read_query</span>

    <span class="k">def</span> <span class="nf">_get_column_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column_stats</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">column_stats</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">_ColumnStats</span><span class="p">(</span><span class="n">column_stats</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">as_of</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VersionQueryInput</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">date_range</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DateRangeInput</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">row_range</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">columns</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">query_builder</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">QueryBuilder</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VersionedItem</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read data for the named symbol.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbol : `str`</span>
<span class="sd">            Symbol name.</span>
<span class="sd">        as_of : `Optional[VersionQueryInput]`, default=None</span>
<span class="sd">            Return the data as it was as_of the point in time. Defaults to getting the latest version.</span>
<span class="sd">            `int` : specific version number. Negative indexing is supported, with -1 representing the latest version, -2 the version before that, etc.</span>
<span class="sd">            `str` : snapshot name which contains the version</span>
<span class="sd">            `datetime.datetime` : the version of the data that existed as_of the requested point in time</span>
<span class="sd">        date_range: `Optional[DateRangeInput]`, default=None</span>
<span class="sd">            DateRange to read data for.  Applicable only for Pandas data with a DateTime index. Returns only the part</span>
<span class="sd">            of the data that falls within the given range.</span>
<span class="sd">        row_range: `Optional[Tuple[int, int]]`, default=None</span>
<span class="sd">            Row range to read data for. Inclusive of the lower bound, exclusive of the upper bound</span>
<span class="sd">            lib.read(symbol, row_range=(start, end)).data should behave the same as df.iloc[start:end], including in</span>
<span class="sd">            the handling of negative start/end values. Only one of date_range or row_range can be provided.</span>
<span class="sd">        columns: `Optional[List[str]]`, default=None</span>
<span class="sd">            Applicable only for Pandas data. Determines which columns to return data for.</span>
<span class="sd">        query_builder: &#39;Optional[QueryBuilder]&#39;, default=None</span>
<span class="sd">            A QueryBuilder object to apply to the dataframe before it is returned.</span>
<span class="sd">            For more information see the documentation for the QueryBuilder class.</span>


<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        VersionedItem</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">row_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">row_range</span> <span class="o">=</span> <span class="n">_SignedRowRange</span><span class="p">(</span><span class="n">row_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">row_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">version_query</span><span class="p">,</span> <span class="n">read_options</span><span class="p">,</span> <span class="n">read_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_queries</span><span class="p">(</span>
            <span class="n">as_of</span><span class="p">,</span> <span class="n">date_range</span><span class="p">,</span> <span class="n">row_range</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">query_builder</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="n">read_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_dataframe</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">version_query</span><span class="p">,</span> <span class="n">read_query</span><span class="p">,</span> <span class="n">read_options</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_post_process_dataframe</span><span class="p">(</span><span class="n">read_result</span><span class="p">,</span> <span class="n">read_query</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">head</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">n</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">as_of</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VersionQueryInput</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">columns</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VersionedItem</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the first n rows of data for the named symbol.</span>
<span class="sd">        If n is negative, return all rows EXCEPT the last n rows.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbol : `str`</span>
<span class="sd">            Symbol name.</span>
<span class="sd">        n : &#39;Optional[int]&#39;, default=5</span>
<span class="sd">            number of rows to select</span>
<span class="sd">        as_of : `Optional[VersionQueryInput]`, default=None</span>
<span class="sd">            See documentation of `read` method for more details.</span>
<span class="sd">        columns: `list`</span>
<span class="sd">            Which columns to return for a dataframe.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        VersionedItem</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">row_range</span> <span class="o">=</span> <span class="n">_HeadRange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">version_query</span><span class="p">,</span> <span class="n">read_options</span><span class="p">,</span> <span class="n">read_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_queries</span><span class="p">(</span><span class="n">as_of</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">row_range</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">read_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_dataframe</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">version_query</span><span class="p">,</span> <span class="n">read_query</span><span class="p">,</span> <span class="n">read_options</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_post_process_dataframe</span><span class="p">(</span><span class="n">read_result</span><span class="p">,</span> <span class="n">read_query</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tail</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">as_of</span><span class="p">:</span> <span class="n">VersionQueryInput</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">columns</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VersionedItem</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the last n rows of data for the named symbol.</span>
<span class="sd">        If n is negative, return all rows EXCEPT the first n rows.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbol : `str`</span>
<span class="sd">            Symbol name.</span>
<span class="sd">        n : &#39;Optional[int]&#39;, default=5</span>
<span class="sd">            number of rows to select</span>
<span class="sd">        as_of : `Optional[VersionQueryInput]`, default=None</span>
<span class="sd">            See documentation of `read` method for more details.</span>
<span class="sd">        columns: `list`</span>
<span class="sd">            Which columns to return for a dataframe.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        VersionedItem</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">row_range</span> <span class="o">=</span> <span class="n">_TailRange</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">version_query</span><span class="p">,</span> <span class="n">read_options</span><span class="p">,</span> <span class="n">read_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_queries</span><span class="p">(</span><span class="n">as_of</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">row_range</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">read_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_dataframe</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">version_query</span><span class="p">,</span> <span class="n">read_query</span><span class="p">,</span> <span class="n">read_options</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_post_process_dataframe</span><span class="p">(</span><span class="n">read_result</span><span class="p">,</span> <span class="n">read_query</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_read_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">version_query</span><span class="p">,</span> <span class="n">read_query</span><span class="p">,</span> <span class="n">read_options</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ReadResult</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">read_dataframe_version</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">version_query</span><span class="p">,</span> <span class="n">read_query</span><span class="p">,</span> <span class="n">read_options</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_post_process_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">read_result</span><span class="p">,</span> <span class="n">read_query</span><span class="p">):</span>
        <span class="c1"># post filter</span>
        <span class="n">start_idx</span> <span class="o">=</span> <span class="n">end_idx</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">read_query</span><span class="o">.</span><span class="n">row_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">read_query</span><span class="o">.</span><span class="n">row_filter</span><span class="p">,</span> <span class="n">_RowRange</span><span class="p">):</span>
                <span class="n">start_idx</span> <span class="o">=</span> <span class="n">read_query</span><span class="o">.</span><span class="n">row_filter</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">read_result</span><span class="o">.</span><span class="n">frame_data</span><span class="o">.</span><span class="n">offset</span>
                <span class="n">end_idx</span> <span class="o">=</span> <span class="n">read_query</span><span class="o">.</span><span class="n">row_filter</span><span class="o">.</span><span class="n">end</span> <span class="o">-</span> <span class="n">read_result</span><span class="o">.</span><span class="n">frame_data</span><span class="o">.</span><span class="n">offset</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">read_query</span><span class="o">.</span><span class="n">row_filter</span><span class="p">,</span> <span class="n">_IndexRange</span><span class="p">):</span>
                <span class="n">ts_idx</span> <span class="o">=</span> <span class="n">read_result</span><span class="o">.</span><span class="n">frame_data</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts_idx</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">start_idx</span> <span class="o">=</span> <span class="n">ts_idx</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">datetime64</span><span class="p">(</span><span class="n">read_query</span><span class="o">.</span><span class="n">row_filter</span><span class="o">.</span><span class="n">start_ts</span><span class="p">,</span> <span class="s2">&quot;ns&quot;</span><span class="p">),</span> <span class="n">side</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
                    <span class="n">end_idx</span> <span class="o">=</span> <span class="n">ts_idx</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">datetime64</span><span class="p">(</span><span class="n">read_query</span><span class="o">.</span><span class="n">row_filter</span><span class="o">.</span><span class="n">end_ts</span><span class="p">,</span> <span class="s2">&quot;ns&quot;</span><span class="p">),</span> <span class="n">side</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ArcticNativeException</span><span class="p">(</span><span class="s2">&quot;Unrecognised row_filter type: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">read_query</span><span class="o">.</span><span class="n">row_filter</span><span class="p">)))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">read_result</span><span class="o">.</span><span class="n">frame_data</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">data</span><span class="p">:</span>
                <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">])</span>
            <span class="n">read_result</span><span class="o">.</span><span class="n">frame_data</span> <span class="o">=</span> <span class="n">FrameData</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">read_result</span><span class="o">.</span><span class="n">frame_data</span><span class="o">.</span><span class="n">names</span><span class="p">,</span> <span class="n">read_result</span><span class="o">.</span><span class="n">frame_data</span><span class="o">.</span><span class="n">index_columns</span><span class="p">)</span>

        <span class="n">vitem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adapt_read_res</span><span class="p">(</span><span class="n">read_result</span><span class="p">)</span>

        <span class="c1"># Handle custom normalized data</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">read_result</span><span class="o">.</span><span class="n">keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">meta_struct</span> <span class="o">=</span> <span class="n">denormalize_user_metadata</span><span class="p">(</span><span class="n">read_result</span><span class="o">.</span><span class="n">mmeta</span><span class="p">)</span>

            <span class="n">key_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="o">.</span><span class="n">symbol</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">data</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_batch_read_keys</span><span class="p">(</span><span class="n">read_result</span><span class="o">.</span><span class="n">keys</span><span class="p">)}</span>
            <span class="n">original_data</span> <span class="o">=</span> <span class="n">Flattener</span><span class="p">()</span><span class="o">.</span><span class="n">create_original_obj_from_metastruct_new</span><span class="p">(</span><span class="n">meta_struct</span><span class="p">,</span> <span class="n">key_map</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">VersionedItem</span><span class="p">(</span>
                <span class="n">symbol</span><span class="o">=</span><span class="n">vitem</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
                <span class="n">library</span><span class="o">=</span><span class="n">vitem</span><span class="o">.</span><span class="n">library</span><span class="p">,</span>
                <span class="n">data</span><span class="o">=</span><span class="n">original_data</span><span class="p">,</span>
                <span class="n">version</span><span class="o">=</span><span class="n">vitem</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="n">vitem</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
                <span class="n">host</span><span class="o">=</span><span class="n">vitem</span><span class="o">.</span><span class="n">host</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">vitem</span>

    <span class="k">def</span> <span class="nf">_find_version</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">as_of</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VersionQueryInput</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">raise_on_missing</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VersionedItem</span><span class="p">]:</span>
        <span class="n">version_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_version_query</span><span class="p">(</span><span class="n">as_of</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">read_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_read_options</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">version_handle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">find_version</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">version_query</span><span class="p">,</span> <span class="n">read_options</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">version_handle</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">raise_on_missing</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot find version for symbol=</span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">,as_of=</span><span class="si">{</span><span class="n">as_of</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">version_handle</span>

    <span class="k">def</span> <span class="nf">read_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">as_of</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VersionQueryInput</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read the index key for the named symbol.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbol : `str`</span>
<span class="sd">            Symbol name.</span>
<span class="sd">        as_of : `Optional[VersionQueryInput]`, default=None</span>
<span class="sd">            See documentation of `read` method for more details.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Pandas DataFrame representing the index key in a human-readable format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">version_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_version_query</span><span class="p">(</span><span class="n">as_of</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">denormalize_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">read_index</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">version_query</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">restore_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">as_of</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VersionQueryInput</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VersionedItem</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Makes the latest version of the symbol equal to the as_of specified version.</span>
<span class="sd">        lib.restore_version(sym, as_of) is semantically equivalent o lib.write(sym, lib.read(sym, as_of).data)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbol : `str`</span>
<span class="sd">            Symbol name.</span>
<span class="sd">        as_of : `Optional[VersionQueryInput]`, default=None</span>
<span class="sd">            See documentation of `read` method for more details.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        VersionedItem</span>
<span class="sd">            Includes the version number that was just written.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">version_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_version_query</span><span class="p">(</span><span class="n">as_of</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">read_result</span> <span class="o">=</span> <span class="n">ReadResult</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">restore_version</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">version_query</span><span class="p">))</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">denormalize_user_metadata</span><span class="p">(</span><span class="n">read_result</span><span class="o">.</span><span class="n">udm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalizer</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">VersionedItem</span><span class="p">(</span>
            <span class="n">symbol</span><span class="o">=</span><span class="n">read_result</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
            <span class="n">library</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_library</span><span class="o">.</span><span class="n">library_path</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">read_result</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">meta</span><span class="p">,</span>
            <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">compact_incomplete</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">append</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">convert_int_to_float</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">via_iteration</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">sparsify</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compact previously written un-indexed chunks of data, produced by a tick collector or parallel</span>
<span class="sd">        writes/appends.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbol : `str`</span>
<span class="sd">            Symbol name.</span>
<span class="sd">        append : `bool`</span>
<span class="sd">            Whether the un-indexed chunks of data should be appended to the previous version, or treated like a `write`</span>
<span class="sd">            operation.</span>
<span class="sd">        convert_int_to_float : `bool`</span>
<span class="sd">            Convert integers to floating point type.</span>
<span class="sd">        via_iteration: `Optional[bool]`, default=True</span>
<span class="sd">            Tick collectors can always write data in the correct order, so don&#39;t</span>
<span class="sd">            need to iterate the keys, which is faster. Everything else needs to</span>
<span class="sd">            set this to True.</span>
<span class="sd">        sparsify : `Optional[bool]`, default=False</span>
<span class="sd">            Convert data to sparse format (for tick data only)</span>
<span class="sd">        metadata : `Optional[Any]`, default=None</span>
<span class="sd">            Add user-defined metadata in the same way as write etc</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        VersionedItem</span>
<span class="sd">            The data attribute will be None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">udm</span> <span class="o">=</span> <span class="n">normalize_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span> <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">compact_incomplete</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">append</span><span class="p">,</span> <span class="n">convert_int_to_float</span><span class="p">,</span> <span class="n">via_iteration</span><span class="p">,</span> <span class="n">sparsify</span><span class="p">,</span> <span class="n">udm</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_index_columns_from_descriptor</span><span class="p">(</span><span class="n">descriptor</span><span class="p">):</span>
        <span class="n">norm_info</span> <span class="o">=</span> <span class="n">descriptor</span><span class="o">.</span><span class="n">normalization</span>
        <span class="n">stream_descriptor</span> <span class="o">=</span> <span class="n">descriptor</span><span class="o">.</span><span class="n">stream_descriptor</span>
        <span class="c1"># For explicit integer indexes, the index is actually present in the first column even though the field_count</span>
        <span class="c1"># is 0.</span>
        <span class="n">idx_type</span> <span class="o">=</span> <span class="n">norm_info</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">WhichOneof</span><span class="p">(</span><span class="s2">&quot;index_type&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">idx_type</span> <span class="o">==</span> <span class="s2">&quot;index&quot;</span><span class="p">:</span>
            <span class="n">last_index_column_idx</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">norm_info</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">is_not_range_index</span> <span class="k">else</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># The value of field_count is len(index) - 1</span>
            <span class="n">last_index_column_idx</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">norm_info</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">multi_index</span><span class="o">.</span><span class="n">field_count</span>

        <span class="n">index_columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">field_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">last_index_column_idx</span><span class="p">):</span>
            <span class="n">index_columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">stream_descriptor</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field_idx</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">index_columns</span>

    <span class="k">def</span> <span class="nf">_adapt_read_res</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">read_result</span><span class="p">:</span> <span class="n">ReadResult</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VersionedItem</span><span class="p">:</span>
        <span class="n">frame_data</span> <span class="o">=</span> <span class="n">FrameData</span><span class="o">.</span><span class="n">from_cpp</span><span class="p">(</span><span class="n">read_result</span><span class="o">.</span><span class="n">frame_data</span><span class="p">)</span>

        <span class="n">meta</span> <span class="o">=</span> <span class="n">denormalize_user_metadata</span><span class="p">(</span><span class="n">read_result</span><span class="o">.</span><span class="n">udm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalizer</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalizer</span><span class="o">.</span><span class="n">denormalize</span><span class="p">(</span><span class="n">frame_data</span><span class="p">,</span> <span class="n">read_result</span><span class="o">.</span><span class="n">norm</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">read_result</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">HasField</span><span class="p">(</span><span class="s2">&quot;custom&quot;</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_custom_normalizer</span><span class="o">.</span><span class="n">denormalize</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">read_result</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">custom</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">VersionedItem</span><span class="p">(</span>
            <span class="n">symbol</span><span class="o">=</span><span class="n">read_result</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
            <span class="n">library</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_library</span><span class="o">.</span><span class="n">library_path</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">read_result</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">meta</span><span class="p">,</span>
            <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">list_versions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">symbol</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">snapshot</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">latest_only</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">iterate_on_failure</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">skip_snapshots</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a list of versions filtered by the passed in parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbol : `Optional[str]`, default=None,</span>
<span class="sd">            Symbol to return versions for.  If None, returns versions for all of the symbols in the library.</span>
<span class="sd">        snapshot : `Optional[str]`, default=None,</span>
<span class="sd">            Return the versions contained in the named snapshot.</span>
<span class="sd">        latest_only : `bool`</span>
<span class="sd">            Only include the latest version for each returned symbol. Has no effect if `snapshot` argument is also</span>
<span class="sd">            specified.</span>
<span class="sd">        iterate_on_failure: `bool`</span>
<span class="sd">            Iterate the type in the storage if the top-level key isn&#39;t present.</span>
<span class="sd">        skip_snapshots: `bool`</span>
<span class="sd">            Don&#39;t populate version list with snapshot information.</span>
<span class="sd">            Can improve performance significantly if there are many snapshots.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; lib.list_versions()</span>
<span class="sd">        &gt;&gt;&gt;</span>
<span class="sd">        [{&#39;symbol&#39;: &#39;100m&#39;,</span>
<span class="sd">          &#39;version&#39;: 0,</span>
<span class="sd">          &#39;date&#39;: Timestamp(&#39;2021-09-23 11:48:18.053074428+0000&#39;, tz=&#39;UTC&#39;),</span>
<span class="sd">          &#39;deleted&#39;: False,</span>
<span class="sd">          &#39;snapshots&#39;: []},</span>
<span class="sd">         {&#39;symbol&#39;: &#39;50m&#39;,</span>
<span class="sd">          &#39;version&#39;: 0,</span>
<span class="sd">          &#39;date&#39;: Timestamp(&#39;2021-09-23 11:34:33.560910368+0000&#39;, tz=&#39;UTC&#39;),</span>
<span class="sd">          &#39;deleted&#39;: True,</span>
<span class="sd">          &#39;snapshots&#39;: [&quot;my_snapshot&quot;]},</span>
<span class="sd">        ...</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `List[Dict]`</span>
<span class="sd">            List of dictionaries describing the discovered versions in the library.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">latest_only</span> <span class="ow">and</span> <span class="n">snapshot</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">NativeVersionStore</span><span class="o">.</span><span class="n">_warned_about_list_version_latest_only_and_snapshot</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;latest_only has no effect when snapshot is specified&quot;</span><span class="p">)</span>
            <span class="n">NativeVersionStore</span><span class="o">.</span><span class="n">_warned_about_list_version_latest_only_and_snapshot</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">list_versions</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">,</span> <span class="n">latest_only</span><span class="p">,</span> <span class="n">iterate_on_failure</span><span class="p">,</span> <span class="n">skip_snapshots</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;symbol&quot;</span><span class="p">:</span> <span class="n">version_result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;version&quot;</span><span class="p">:</span> <span class="n">version_result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="s2">&quot;date&quot;</span><span class="p">:</span> <span class="n">to_datetime</span><span class="p">(</span><span class="n">version_result</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;ns&quot;</span><span class="p">,</span> <span class="n">utc</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="s2">&quot;deleted&quot;</span><span class="p">:</span> <span class="n">version_result</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                <span class="s2">&quot;snapshots&quot;</span><span class="p">:</span> <span class="n">version_result</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">version_result</span> <span class="ow">in</span> <span class="n">result</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">list_symbols</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">all_symbols</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">snapshot</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">regex</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">prefix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_symbol_list</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the symbols in this library.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        all_symbols : `Optional[bool]`, default=False</span>
<span class="sd">            If True returns all symbols under all snapshots, even if the symbol has been deleted</span>
<span class="sd">            in the current version (i.e. it exists under a snapshot... Default: False</span>
<span class="sd">        snapshot : `Optional[str]`, default=None</span>
<span class="sd">            Return the symbols available under the specified snapshot.</span>
<span class="sd">        regex : `Optional[str]`, default=None</span>
<span class="sd">            filter symbols by the passed in regular expression</span>
<span class="sd">        prefix : `Optional[str]`, default=None</span>
<span class="sd">            filter symbols by the given prefix. Only supported by S3 backend for now.</span>
<span class="sd">        use_symbol_list: `Optional[bool]`, default=None</span>
<span class="sd">            If True, ignore the symbol list and get all symbols using iteration.</span>
<span class="sd">            ignored if all_symbols=True</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>

<span class="sd">        &gt;&gt;&gt; lib.list_symbols()</span>
<span class="sd">        [&#39;test_symbol&#39;, &#39;symbol&#39;, &#39;50m&#39;]</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `List[str]`</span>
<span class="sd">            String list of symbols in the library.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">all_symbols</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">use_symbol_list</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Cannot use symbol list with all_symbols=True as it only stores undeleted symbols&quot;</span><span class="p">)</span>
            <span class="n">use_symbol_list</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">list_streams</span><span class="p">(</span><span class="n">snapshot</span><span class="p">,</span> <span class="n">regex</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">use_symbol_list</span><span class="p">,</span> <span class="n">all_symbols</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">list_snapshots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">load_metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        List the snapshots in the library.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        load_metadata : `Optional[bool]`, default=True</span>
<span class="sd">            Load the snapshot metadata. May be slow so opt for false if you don&#39;t need it.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `Dict[str, Any]`</span>
<span class="sd">            Dictionary mapping snapshot names to their associated metadata, or to Nones if load_metadata is False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">snap_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">list_snapshots</span><span class="p">(</span><span class="n">load_metadata</span><span class="p">)</span>
        <span class="n">denormalized_snap_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">snap_name</span><span class="p">,</span> <span class="n">normalized_metadata</span> <span class="ow">in</span> <span class="n">snap_data</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="n">denormalize_user_metadata</span><span class="p">(</span><span class="n">normalized_metadata</span><span class="p">)</span> <span class="k">if</span> <span class="n">normalized_metadata</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">denormalized_snap_data</span><span class="p">[</span><span class="n">snap_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>

        <span class="k">return</span> <span class="n">denormalized_snap_data</span>

    <span class="k">def</span> <span class="nf">snapshot</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">snap_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">skip_symbols</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">versions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a named snapshot of the data within a library.</span>

<span class="sd">        By default, the latest version of each active symbol at the time of snapshot creation will be contained within</span>
<span class="sd">        the snapshot. The symbols and versions contained within the snapshot will persist regardless of new symbols</span>
<span class="sd">        and versions written to the library post snapshot creation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        snap_name : `str`</span>
<span class="sd">            Name of the snapshot.</span>
<span class="sd">        metadata : `Optional[Any]`, default=None</span>
<span class="sd">            Optional metadata to persist along with the snapshot.</span>
<span class="sd">        skip_symbols : `Optional[List[str]]`, default=None</span>
<span class="sd">            Optional list of symbols to be excluded from the snapshot.</span>
<span class="sd">        versions: `Optional[Dict[str, int]]`, default=None</span>
<span class="sd">            Optional dictionary of versions of the symbols to include in the snapshot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_symbols</span><span class="p">:</span>
            <span class="n">skip_symbols</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">versions</span><span class="p">:</span>
            <span class="n">versions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="n">normalize_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span> <span class="k">if</span> <span class="n">metadata</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">snapshot</span><span class="p">(</span><span class="n">snap_name</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">skip_symbols</span><span class="p">,</span> <span class="n">versions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">delete_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snap_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete a named snapshot. This may be slow if the given snapshot is the last reference to the underlying</span>
<span class="sd">        symbol(s) as the associated data will have to be removed as well.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        snap_name : `str`</span>
<span class="sd">            The snapshot name to delete.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">delete_snapshot</span><span class="p">(</span><span class="n">snap_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add_to_snapshot</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">snap_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">as_ofs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">VersionQueryInput</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add items to a snapshot. Will replace if the snapshot already contains an entry for a particular symbol.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        snap_name : `str`</span>
<span class="sd">            The snapshot name to modify.</span>
<span class="sd">        symbols : `List[str]`</span>
<span class="sd">            The symbols to add/modify entries for.</span>
<span class="sd">        as_ofs : `Optional[List[VersionQueryInput]]`, default=None</span>
<span class="sd">            List of version queries. See documentation of `read` method for more details.</span>
<span class="sd">            i-th entry corresponds to i-th element of `symbols`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">version_queries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_version_queries</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">symbols</span><span class="p">),</span> <span class="n">as_ofs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">add_to_snapshot</span><span class="p">(</span><span class="n">snap_name</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">version_queries</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove_from_snapshot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">snap_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">versions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove items from a snapshot</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        snap_name : `str`</span>
<span class="sd">            The snapshot name to modify.</span>
<span class="sd">        symbols : List[str]</span>
<span class="sd">            The symbols to remove entries for.</span>
<span class="sd">        versions : List[int]</span>
<span class="sd">            The versions to remove entries for.</span>
<span class="sd">            i-th entry corresponds to i-th element of `symbols`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">remove_from_snapshot</span><span class="p">(</span><span class="n">snap_name</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">versions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">date_range</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">DateRangeInput</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete all versions of the item from the library which aren&#39;t part of at least one snapshot.</span>

<span class="sd">        Note that this requires data to be removed from the underlying storage which can be slow if the underlying</span>
<span class="sd">        delete primitives offered by the storage are slow.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbol : `str`</span>
<span class="sd">            Symbol name to delete</span>
<span class="sd">        date_range: `Optional[DateRangeInput]`, default=None</span>
<span class="sd">            If provided, deletes rows that fall within the given range from the latest live version. Note this is</span>
<span class="sd">            end-inclusive.</span>
<span class="sd">            If not provided then all versions of the symbol will be removed in their entirety (unless accessible via at</span>
<span class="sd">            least one snapshot).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">date_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dynamic_schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_defaults</span><span class="p">(</span>
                <span class="s2">&quot;dynamic_schema&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lib_cfg</span><span class="o">.</span><span class="n">lib_desc</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">write_options</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
            <span class="n">update_query</span> <span class="o">=</span> <span class="n">_PythonVersionStoreUpdateQuery</span><span class="p">()</span>
            <span class="n">update_query</span><span class="o">.</span><span class="n">row_filter</span> <span class="o">=</span> <span class="n">_normalize_dt_range</span><span class="p">(</span><span class="n">date_range</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">delete_range</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">update_query</span><span class="p">,</span> <span class="n">dynamic_schema</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">delete_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">version_num</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete the given version of this symbol.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbol : `str`</span>
<span class="sd">            Symbol name.</span>
<span class="sd">        version_num : `int`</span>
<span class="sd">            Version to be deleted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">delete_version</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">version_num</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">prune_previous_versions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes all (non-snapshotted) versions from the database for the given symbol, except the latest.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbol : `str`</span>
<span class="sd">            Symbol name to prune.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">prune_previous_versions</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_prune_previous_versions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">keep_mins</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">120</span><span class="p">,</span> <span class="n">keep_version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes all (non-snapshotted) versions older than keep_mins from the database for the given symbol, except the</span>
<span class="sd">        latest.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbol : `str`</span>
<span class="sd">            symbol name to prune</span>
<span class="sd">        keep_mins : &#39;Optional[int]&#39;, default=120</span>
<span class="sd">            Delete versions older than keep_mins</span>
<span class="sd">        keep_version:  `Optional[int]`, default=None</span>
<span class="sd">            Version number not to be deleted</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">versions</span> <span class="o">=</span> <span class="p">[</span><span class="n">ver</span> <span class="k">for</span> <span class="n">ver</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_versions</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span> <span class="k">if</span> <span class="n">ver</span><span class="p">[</span><span class="s2">&quot;deleted&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">]</span>
        <span class="c1"># We never prune the latest version</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">versions</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">versions</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">versions</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">versions</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unexpected version list received, not sorted. Aborting prune previous&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">versions</span> <span class="o">=</span> <span class="n">versions</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">versions</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">keep_version</span><span class="p">,</span> <span class="n">versions</span><span class="p">)</span>
        <span class="n">keep_date</span> <span class="o">=</span> <span class="n">Timestamp</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="n">Timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">keep_mins</span><span class="p">)</span>
        <span class="n">delete_versions</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">keep_date</span><span class="p">,</span> <span class="n">versions</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">v_info</span> <span class="ow">in</span> <span class="n">delete_versions</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deleting version: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v_info</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">])))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete_version</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">v_info</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">])</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Done deleting version: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v_info</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">])))</span>

    <span class="k">def</span> <span class="nf">has_symbol</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">as_of</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VersionQueryInput</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">iterate_on_failure</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return True if the &#39;symbol&#39; exists in this library AND the symbol isn&#39;t deleted in the specified as_of.</span>
<span class="sd">        It&#39;s possible for a deleted symbol to exist in snapshots.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbol : `str`</span>
<span class="sd">            symbol name</span>
<span class="sd">        as_of : `Optional[VersionQueryInput]`, default=None</span>
<span class="sd">            See documentation of `read` method for more details.</span>
<span class="sd">        iterate_on_failure: `Optional[bool]`, default=False</span>
<span class="sd">            Iterate the type in the storage if the top-level key isn;t present</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `bool`</span>
<span class="sd">            True if the symbol exists as_of the specified revision, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_find_version</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">as_of</span><span class="o">=</span><span class="n">as_of</span><span class="p">,</span> <span class="n">raise_on_missing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">iterate_on_failure</span><span class="o">=</span><span class="n">iterate_on_failure</span><span class="p">)</span>
            <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">column_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">as_of</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VersionQueryInput</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the column names of the data for a given symbol.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbol : `str`</span>
<span class="sd">            Symbol name</span>
<span class="sd">        as_of : `Optional[VersionQueryInput]`, default=None,</span>
<span class="sd">            See documentation of `read` method for more details.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `List[str]`</span>
<span class="sd">            A list of column names associated with the symbol as of the specified revision.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">as_of</span><span class="p">)[</span><span class="s2">&quot;col_names&quot;</span><span class="p">][</span><span class="s2">&quot;columns&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">update_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">as_of</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VersionQueryInput</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">datetime64</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the time of the most recent update for a symbol in a given version.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbol : `str`</span>
<span class="sd">            symbol name</span>
<span class="sd">        as_of : `Optional[VersionQueryInput]`, default=None</span>
<span class="sd">            See documentation of `read` method for more details.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `datetime64`</span>
<span class="sd">            The time that the specified revision of the symbol was updated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">version_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_version_query</span><span class="p">(</span><span class="n">as_of</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">datetime64</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">get_update_time</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">version_query</span><span class="p">),</span> <span class="s2">&quot;ns&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_times</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">as_ofs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">VersionQueryInput</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">datetime64</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the time of the most recent update for a list of symbols in given versions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbols : `List[str]`</span>
<span class="sd">            symbol names</span>
<span class="sd">        as_ofs: `Optional[List[VersionQueryInput]]`, default=None</span>
<span class="sd">            See documentation of `read` method for more details.</span>
<span class="sd">            i-th entry corresponds to i-th element of `symbols`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `List[datetime64]`</span>
<span class="sd">            List of the times that the specified revisions of the symbols were updated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">version_queries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_version_queries</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">symbols</span><span class="p">),</span> <span class="n">as_ofs</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">datetime64</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s2">&quot;ns&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">get_update_times</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="n">version_queries</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">read_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">as_of</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VersionQueryInput</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VersionedItem</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return the metadata saved for a symbol.  This method is fast as it doesn&#39;t actually load the data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbol : `str`</span>
<span class="sd">            symbol name</span>
<span class="sd">        as_of : `Optional[VersionQueryInput]`, default=None</span>
<span class="sd">            See documentation of `read` method for more details.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `VersionedItem`</span>
<span class="sd">            Structure including the metadata read from the store.</span>
<span class="sd">            The data attribute will not be populated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">version_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_version_query</span><span class="p">(</span><span class="n">as_of</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">read_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_read_options</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">version_item</span><span class="p">,</span> <span class="n">udm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">read_metadata</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">version_query</span><span class="p">,</span> <span class="n">read_options</span><span class="p">)</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="n">denormalize_user_metadata</span><span class="p">(</span><span class="n">udm</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalizer</span><span class="p">)</span> <span class="k">if</span> <span class="n">udm</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">VersionedItem</span><span class="p">(</span>
            <span class="n">symbol</span><span class="o">=</span><span class="n">symbol</span><span class="p">,</span>
            <span class="n">library</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_library</span><span class="o">.</span><span class="n">library_path</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">version_item</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="n">meta</span><span class="p">,</span>
            <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lib_cfg</span><span class="o">.</span><span class="n">lib_desc</span><span class="o">.</span><span class="n">WhichOneof</span><span class="p">(</span><span class="s2">&quot;store_type&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_normalizer_for_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Useful util to get the normalizer that will be used for any given item.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalizer</span><span class="o">.</span><span class="n">get_normalizer_for_type</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">will_item_be_pickled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_udm</span><span class="p">,</span> <span class="n">_item</span><span class="p">,</span> <span class="n">norm_meta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_try_normalize</span><span class="p">(</span>
                <span class="n">symbol</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">dataframe</span><span class="o">=</span><span class="n">item</span><span class="p">,</span>
                <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">pickle_on_failure</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">dynamic_strings</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># TODO: Enable it when on by default.</span>
                <span class="n">coerce_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># This will also log the exception inside composite normalizer&#39;s normalize</span>
            <span class="k">return</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">norm_meta</span><span class="o">.</span><span class="n">WhichOneof</span><span class="p">(</span><span class="s2">&quot;input_type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;msg_pack_frame&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_arctic_style_type_info_for_norm</span><span class="p">(</span><span class="n">desc</span><span class="p">):</span>
        <span class="c1"># Arctic used to have a type field in get_info which had info about the underlying store being used.</span>
        <span class="c1"># This is to provide some sort of compatibility to that notation</span>
        <span class="c1"># eg: https://github.com/manahl/arctic/blob/master/arctic/store/_pandas_ndarray_store.py#L177</span>
        <span class="n">input_type</span> <span class="o">=</span> <span class="n">desc</span><span class="o">.</span><span class="n">normalization</span><span class="o">.</span><span class="n">WhichOneof</span><span class="p">(</span><span class="s2">&quot;input_type&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">input_type</span> <span class="o">==</span> <span class="s2">&quot;df&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;pandasdf&quot;</span>
        <span class="k">elif</span> <span class="n">input_type</span> <span class="o">==</span> <span class="s2">&quot;series&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;pandasseries&quot;</span>
        <span class="k">elif</span> <span class="n">input_type</span> <span class="o">==</span> <span class="s2">&quot;np&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;ndarray&quot;</span>
        <span class="k">elif</span> <span class="n">input_type</span> <span class="o">==</span> <span class="s2">&quot;msg_pack_frame&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;pickled&quot;</span>
        <span class="k">elif</span> <span class="n">input_type</span> <span class="o">==</span> <span class="s2">&quot;ts&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;normalized_timeseries&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;missing_type_info&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">is_pickled_descriptor</span><span class="p">(</span><span class="n">desc</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">desc</span><span class="o">.</span><span class="n">normalization</span><span class="o">.</span><span class="n">WhichOneof</span><span class="p">(</span><span class="s2">&quot;input_type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;msg_pack_frame&quot;</span>

    <span class="k">def</span> <span class="nf">is_symbol_pickled</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">as_of</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VersionQueryInput</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query if the symbol as of the specified revision is pickled.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbol : `str`</span>
<span class="sd">            symbol name</span>
<span class="sd">        as_of : `Optional[VersionQueryInput]`, default=None</span>
<span class="sd">            See documentation of `read` method for more details.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `bool`</span>
<span class="sd">            True if the symbol is pickled, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">version_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_version_query</span><span class="p">(</span><span class="n">as_of</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">read_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_read_options</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">dit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">read_descriptor</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">version_query</span><span class="p">,</span> <span class="n">read_options</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_pickled_descriptor</span><span class="p">(</span><span class="n">dit</span><span class="o">.</span><span class="n">timeseries_descriptor</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_time_range_from_ts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">desc</span><span class="p">,</span> <span class="n">min_ts</span><span class="p">,</span> <span class="n">max_ts</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">min_ts</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">max_ts</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">datetime64</span><span class="p">(</span><span class="s2">&quot;nat&quot;</span><span class="p">),</span> <span class="n">datetime64</span><span class="p">(</span><span class="s2">&quot;nat&quot;</span><span class="p">)</span>
        <span class="n">input_type</span> <span class="o">=</span> <span class="n">desc</span><span class="o">.</span><span class="n">normalization</span><span class="o">.</span><span class="n">WhichOneof</span><span class="p">(</span><span class="s2">&quot;input_type&quot;</span><span class="p">)</span>
        <span class="n">tz</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">input_type</span> <span class="o">==</span> <span class="s2">&quot;df&quot;</span><span class="p">:</span>
            <span class="n">index_metadata</span> <span class="o">=</span> <span class="n">desc</span><span class="o">.</span><span class="n">normalization</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">common</span>
            <span class="n">tz</span> <span class="o">=</span> <span class="n">get_timezone_from_metadata</span><span class="p">(</span><span class="n">index_metadata</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tz</span><span class="p">:</span>
            <span class="c1"># If tz is provided, it is stored in UTC - hence needs to be localized to UTC before</span>
            <span class="c1"># converting to the given tz</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">_from_tz_timestamp</span><span class="p">(</span><span class="n">min_ts</span><span class="p">,</span> <span class="s2">&quot;UTC&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="n">tz</span><span class="p">)),</span>
                <span class="n">_from_tz_timestamp</span><span class="p">(</span><span class="n">max_ts</span><span class="p">,</span> <span class="s2">&quot;UTC&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="n">tz</span><span class="p">)),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_from_tz_timestamp</span><span class="p">(</span><span class="n">min_ts</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">_from_tz_timestamp</span><span class="p">(</span><span class="n">max_ts</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_timerange_for_symbol</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VersionQueryInput</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">datetime</span><span class="p">,</span> <span class="n">datetime</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query the earliest and latest timestamp in the index of the specified revision of the symbol.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbol : `str`</span>
<span class="sd">            symbol name</span>
<span class="sd">        as_of : `Optional[VersionQueryInput]`, default=None</span>
<span class="sd">            See documentation of `read` method for more details.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `Tuple[datetime, datetime]`</span>
<span class="sd">            The earliest and latest timestamps in the index.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">given_version</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">v</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_versions</span><span class="p">(</span><span class="n">symbol</span><span class="p">)])</span> <span class="k">if</span> <span class="n">version</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">version</span>
        <span class="n">version_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_version_query</span><span class="p">(</span><span class="n">given_version</span><span class="p">)</span>
        <span class="n">read_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_read_options</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">read_index</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">version_query</span><span class="p">)</span>
        <span class="n">frame_data</span> <span class="o">=</span> <span class="n">ReadResult</span><span class="p">(</span><span class="o">*</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">frame_data</span>
        <span class="n">index_data</span> <span class="o">=</span> <span class="n">FrameData</span><span class="o">.</span><span class="n">from_cpp</span><span class="p">(</span><span class="n">frame_data</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">datetime64</span><span class="p">(</span><span class="s2">&quot;nat&quot;</span><span class="p">),</span> <span class="n">datetime64</span><span class="p">(</span><span class="s2">&quot;nat&quot;</span><span class="p">)</span>

        <span class="n">start_indices</span><span class="p">,</span> <span class="n">end_indices</span> <span class="o">=</span> <span class="n">index_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">index_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">min_ts</span><span class="p">,</span> <span class="n">max_ts</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">start_indices</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">end_indices</span><span class="p">)</span>
        <span class="c1"># to get timezone info</span>
        <span class="n">dit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">read_descriptor</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">version_query</span><span class="p">,</span> <span class="n">read_options</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time_range_from_ts</span><span class="p">(</span><span class="n">dit</span><span class="o">.</span><span class="n">timeseries_descriptor</span><span class="p">,</span> <span class="n">min_ts</span><span class="p">,</span> <span class="n">max_ts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lib_cfg</span><span class="o">.</span><span class="n">lib_desc</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="nf">get_num_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">as_of</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VersionQueryInput</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Query the number of rows in the specified revision of the symbol.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbol : `str`</span>
<span class="sd">            symbol name</span>
<span class="sd">        as_of : `Optional[VersionQueryInput]`, default=None</span>
<span class="sd">            See documentation of `read` method for more details.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `int`</span>
<span class="sd">            The number of rows in the specified revision of the symbol.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">version_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_version_query</span><span class="p">(</span><span class="n">as_of</span><span class="p">)</span>
        <span class="n">dit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">read_descriptor</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">version_query</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dit</span><span class="o">.</span><span class="n">timeseries_descriptor</span><span class="o">.</span><span class="n">total_rows</span>

    <span class="k">def</span> <span class="nf">lib_cfg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lib_cfg</span>

    <span class="k">def</span> <span class="nf">open_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_mode</span>

    <span class="k">def</span> <span class="nf">_process_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dit</span><span class="p">,</span> <span class="n">as_of</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VersionQueryInput</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="n">timeseries_descriptor</span> <span class="o">=</span> <span class="n">dit</span><span class="o">.</span><span class="n">timeseries_descriptor</span>
        <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">timeseries_descriptor</span><span class="o">.</span><span class="n">stream_descriptor</span><span class="o">.</span><span class="n">fields</span><span class="p">]</span>
        <span class="n">dtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">type_desc</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">timeseries_descriptor</span><span class="o">.</span><span class="n">stream_descriptor</span><span class="o">.</span><span class="n">fields</span><span class="p">]</span>
        <span class="n">index</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">index_dtype</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">input_type</span> <span class="o">=</span> <span class="n">timeseries_descriptor</span><span class="o">.</span><span class="n">normalization</span><span class="o">.</span><span class="n">WhichOneof</span><span class="p">(</span><span class="s2">&quot;input_type&quot;</span><span class="p">)</span>
        <span class="n">index_type</span> <span class="o">=</span> <span class="s2">&quot;NA&quot;</span>
        <span class="k">if</span> <span class="n">input_type</span> <span class="o">==</span> <span class="s2">&quot;df&quot;</span><span class="p">:</span>
            <span class="n">index_type</span> <span class="o">=</span> <span class="n">timeseries_descriptor</span><span class="o">.</span><span class="n">normalization</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">WhichOneof</span><span class="p">(</span><span class="s2">&quot;index_type&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">index_type</span> <span class="o">==</span> <span class="s2">&quot;index&quot;</span><span class="p">:</span>
                <span class="n">index_metadata</span> <span class="o">=</span> <span class="n">timeseries_descriptor</span><span class="o">.</span><span class="n">normalization</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">index</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">index_metadata</span> <span class="o">=</span> <span class="n">timeseries_descriptor</span><span class="o">.</span><span class="n">normalization</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">common</span><span class="o">.</span><span class="n">multi_index</span>

            <span class="k">if</span> <span class="n">index_type</span> <span class="o">==</span> <span class="s2">&quot;multi_index&quot;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">index_type</span> <span class="o">==</span> <span class="s2">&quot;index&quot;</span> <span class="ow">and</span> <span class="n">index_metadata</span><span class="o">.</span><span class="n">is_not_range_index</span><span class="p">):</span>
                <span class="n">index_name_from_store</span> <span class="o">=</span> <span class="n">columns</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">has_fake_name</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="mi">0</span> <span class="ow">in</span> <span class="n">index_metadata</span><span class="o">.</span><span class="n">fake_field_pos</span> <span class="k">if</span> <span class="n">index_type</span> <span class="o">==</span> <span class="s2">&quot;multi_index&quot;</span> <span class="k">else</span> <span class="n">index_metadata</span><span class="o">.</span><span class="n">fake_name</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">has_fake_name</span><span class="p">:</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">index_name_from_store</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">index_name_from_store</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">index_metadata</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">index_metadata</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
                <span class="n">index_dtype</span> <span class="o">=</span> <span class="p">[</span><span class="n">dtypes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># RangeIndex</span>
                <span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="n">index_metadata</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="n">index_metadata</span><span class="o">.</span><span class="n">name</span> <span class="k">else</span> <span class="kc">None</span><span class="p">]</span>
                <span class="n">dtype_desc</span> <span class="o">=</span> <span class="n">TypeDescriptor</span><span class="p">()</span>
                <span class="n">dtype_desc</span><span class="o">.</span><span class="n">value_type</span> <span class="o">=</span> <span class="n">TypeDescriptor</span><span class="o">.</span><span class="n">ValueType</span><span class="o">.</span><span class="n">INT</span>
                <span class="n">index_dtype</span> <span class="o">=</span> <span class="p">[</span><span class="n">dtype_desc</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">index_type</span> <span class="o">==</span> <span class="s2">&quot;multi_index&quot;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">index_metadata</span><span class="o">.</span><span class="n">field_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
                    <span class="n">index_name</span> <span class="o">=</span> <span class="n">columns</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">index_metadata</span><span class="o">.</span><span class="n">fake_field_pos</span><span class="p">:</span>
                        <span class="n">index_name</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">index_name</span> <span class="o">=</span> <span class="n">index_name</span><span class="p">[</span><span class="n">_IDX_PREFIX_LEN</span><span class="p">:]</span>
                    <span class="n">index</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index_name</span><span class="p">)</span>
                    <span class="n">index_dtype</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dtypes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">timeseries_descriptor</span><span class="o">.</span><span class="n">normalization</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">has_synthetic_columns</span><span class="p">:</span>
                <span class="n">columns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">RangeIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns</span><span class="p">))</span>

        <span class="n">date_range</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_time_range_from_ts</span><span class="p">(</span><span class="n">timeseries_descriptor</span><span class="p">,</span> <span class="n">dit</span><span class="o">.</span><span class="n">start_index</span><span class="p">,</span> <span class="n">dit</span><span class="o">.</span><span class="n">end_index</span><span class="p">)</span>
        <span class="n">last_update</span> <span class="o">=</span> <span class="n">datetime64</span><span class="p">(</span><span class="n">dit</span><span class="o">.</span><span class="n">creation_ts</span><span class="p">,</span> <span class="s2">&quot;ns&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;col_names&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;columns&quot;</span><span class="p">:</span> <span class="n">columns</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">index</span><span class="p">,</span> <span class="s2">&quot;index_dtype&quot;</span><span class="p">:</span> <span class="n">index_dtype</span><span class="p">},</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">:</span> <span class="n">dtypes</span><span class="p">,</span>
            <span class="s2">&quot;rows&quot;</span><span class="p">:</span> <span class="n">timeseries_descriptor</span><span class="o">.</span><span class="n">total_rows</span><span class="p">,</span>
            <span class="s2">&quot;last_update&quot;</span><span class="p">:</span> <span class="n">last_update</span><span class="p">,</span>
            <span class="s2">&quot;input_type&quot;</span><span class="p">:</span> <span class="n">input_type</span><span class="p">,</span>
            <span class="s2">&quot;index_type&quot;</span><span class="p">:</span> <span class="n">index_type</span><span class="p">,</span>
            <span class="s2">&quot;normalization_metadata&quot;</span><span class="p">:</span> <span class="n">timeseries_descriptor</span><span class="o">.</span><span class="n">normalization</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_arctic_style_type_info_for_norm</span><span class="p">(</span><span class="n">timeseries_descriptor</span><span class="p">),</span>
            <span class="s2">&quot;date_range&quot;</span><span class="p">:</span> <span class="n">date_range</span><span class="p">,</span>
            <span class="s2">&quot;sorted&quot;</span><span class="p">:</span> <span class="n">SortedValue</span><span class="o">.</span><span class="n">Name</span><span class="p">(</span><span class="n">timeseries_descriptor</span><span class="o">.</span><span class="n">stream_descriptor</span><span class="o">.</span><span class="n">sorted</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">VersionQueryInput</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns descriptive data for `symbol`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbol : `str`</span>
<span class="sd">            symbol name</span>
<span class="sd">        version : `Optional[VersionQueryInput]`, default=None</span>
<span class="sd">            See documentation of `read` method for more details.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `Dict[str, Any]`</span>
<span class="sd">            Dictionary containing the following fields:</span>

<span class="sd">            - col_names, `Dict`</span>
<span class="sd">            - dtype, `List`</span>
<span class="sd">            - rows, `int`</span>
<span class="sd">            - last_update, `datetime`</span>
<span class="sd">            - input_type, `str`</span>
<span class="sd">            - index_type, `index_type`</span>
<span class="sd">            - normalization_metadata,</span>
<span class="sd">            - type, `str`</span>
<span class="sd">            - date_range, `tuple`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">version_query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_version_query</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>
        <span class="n">read_options</span> <span class="o">=</span> <span class="n">_PythonVersionStoreReadOptions</span><span class="p">()</span>
        <span class="n">dit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">read_descriptor</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">version_query</span><span class="p">,</span> <span class="n">read_options</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_info</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">dit</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">batch_get_info</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">as_ofs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">VersionQueryInput</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns descriptive data for a list of `symbols`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbols : `str`</span>
<span class="sd">            symbols: `List[str]`</span>
<span class="sd">                List of symbols to read the descriptor info for.</span>
<span class="sd">            as_ofs: `Optional[List[VersionQueryInput]]`, default=None</span>
<span class="sd">                List of version queries. See documentation of `read` method for more details.</span>
<span class="sd">                i-th entry corresponds to i-th element of `symbols`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `List[Dict[str, Any]]`</span>
<span class="sd">            List of Dictionaries containing the following fields:</span>

<span class="sd">            - col_names, `Dict`</span>
<span class="sd">            - dtype, `List`</span>
<span class="sd">            - rows, `int`</span>
<span class="sd">            - last_update, `datetime`</span>
<span class="sd">            - input_type, `str`</span>
<span class="sd">            - index_type, `index_type`</span>
<span class="sd">            - normalization_metadata,</span>
<span class="sd">            - type, `str`</span>
<span class="sd">            - date_range, `tuple`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">as_ofs_lists</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">as_ofs</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">as_ofs_lists</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">symbols</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">as_ofs_lists</span> <span class="o">=</span> <span class="n">as_ofs</span>

        <span class="n">version_queries</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">as_of</span> <span class="ow">in</span> <span class="n">as_ofs_lists</span><span class="p">:</span>
            <span class="n">version_queries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_version_query</span><span class="p">(</span><span class="n">as_of</span><span class="p">))</span>

        <span class="n">read_options</span> <span class="o">=</span> <span class="n">_PythonVersionStoreReadOptions</span><span class="p">()</span>
        <span class="n">list_descriptors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">batch_read_descriptor</span><span class="p">(</span><span class="n">symbols</span><span class="p">,</span> <span class="n">version_queries</span><span class="p">,</span> <span class="n">read_options</span><span class="p">)</span>
        <span class="n">args_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">list_descriptors</span><span class="p">,</span> <span class="n">symbols</span><span class="p">,</span> <span class="n">version_queries</span><span class="p">,</span> <span class="n">as_ofs_lists</span><span class="p">))</span>
        <span class="n">list_infos</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">dit</span><span class="p">,</span> <span class="n">symbol</span><span class="p">,</span> <span class="n">version_query</span><span class="p">,</span> <span class="n">as_of</span> <span class="ow">in</span> <span class="n">args_list</span><span class="p">:</span>
            <span class="n">list_infos</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_process_info</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">dit</span><span class="p">,</span> <span class="n">as_of</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">list_infos</span>

    <span class="k">def</span> <span class="nf">write_metadata</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">metadata</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">prune_previous_version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VersionedItem</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write &#39;metadata&#39; under the specified &#39;symbol&#39; name to this library.</span>
<span class="sd">        The data will remain unchanged. A new version will be created.</span>
<span class="sd">        If the symbol is missing, it causes a write with empty data (pickled, can&#39;t append) and the supplied metadata.</span>
<span class="sd">        Returns a VersionedItem object with only a metadata element.</span>
<span class="sd">        This operation is fast as there are zero data segment read/write operations.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbol : `str`</span>
<span class="sd">            symbol name</span>
<span class="sd">        metadata : `Any`</span>
<span class="sd">            metadata to persist along with the symbol data</span>
<span class="sd">        prune_previous_version : `Optional[bool]`, default=None</span>
<span class="sd">            Removes previous (non-snapshotted) versions from the database.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        `VersionedItem`</span>
<span class="sd">            VersionedItem containing the metadata of the written symbol&#39;s version in the store.</span>
<span class="sd">            The data attribute will not be populated.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_symbol_validity</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>

        <span class="n">proto_cfg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lib_cfg</span><span class="o">.</span><span class="n">lib_desc</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">write_options</span>

        <span class="n">prune_previous_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_defaults</span><span class="p">(</span>
            <span class="s2">&quot;prune_previous_version&quot;</span><span class="p">,</span> <span class="n">proto_cfg</span><span class="p">,</span> <span class="n">global_default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">existing_value</span><span class="o">=</span><span class="n">prune_previous_version</span>
        <span class="p">)</span>
        <span class="n">udm</span> <span class="o">=</span> <span class="n">normalize_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span> <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_symbol</span><span class="p">(</span><span class="n">symbol</span><span class="p">):</span>
            <span class="c1"># Handle this here so write_metadata in C++ always has a symbol to work with</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">prune_previous_version</span><span class="o">=</span><span class="n">prune_previous_version</span><span class="p">)</span>

        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">write_metadata</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">udm</span><span class="p">,</span> <span class="n">prune_previous_version</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_thin_cxx_item_to_python</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">scan_object_sizes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">scan_object_sizes</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">sizes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> </span><span class="se">\t</span><span class="s2">Objects: </span><span class="si">{}</span><span class="se">\t</span><span class="s2">Total Size: </span><span class="si">{}</span><span class="se">\t</span><span class="s2">Avg Size </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">format_bytes</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">format_bytes</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="p">)</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_symbol_fragmented</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">segment_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check whether the number of segments that would be reduced by compaction is more than or equal to the</span>
<span class="sd">        value specified by the configuration option &quot;SymbolDataCompact.SegmentCount&quot; (defaults to 100).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbol: `str`</span>
<span class="sd">            Symbol name.</span>
<span class="sd">        segment_size: `int`</span>
<span class="sd">            Target for maximum no. of rows per segment, after compaction.</span>
<span class="sd">            If parameter is not provided, library option for segments&#39;s maximum row size will be used</span>

<span class="sd">        Notes</span>
<span class="sd">        ----------</span>
<span class="sd">        Config map setting - SymbolDataCompact.SegmentCount will be replaced by a library setting</span>
<span class="sd">        in the future. This API will allow overriding the setting as well.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">is_symbol_fragmented</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">segment_size</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">defragment_symbol_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">segment_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">VersionedItem</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compacts fragmented segments by merging row-sliced segments (https://docs.arcticdb.io/technical/on_disk_storage/#data-layer).</span>
<span class="sd">        This method calls `is_symbol_fragmented` to determine whether to proceed with the defragmentation operation.</span>

<span class="sd">        CAUTION - Please note that a major restriction of this method at present is that any column slicing present on the data will be</span>
<span class="sd">        removed in the new version created as a result of this method.</span>
<span class="sd">        As a result, if the impacted symbol has more than 127 columns (default value), the performance of selecting individual columns of</span>
<span class="sd">        the symbol (by using the `columns` parameter) may be negatively impacted in the defragmented version.</span>
<span class="sd">        If your symbol has less than 127 columns this caveat does not apply.</span>
<span class="sd">        For more information, please see `columns_per_segment` here:</span>

<span class="sd">        https://docs.arcticdb.io/api/arcticdb/arcticdb.LibraryOptions</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        symbol: `str`</span>
<span class="sd">            Symbol name.</span>
<span class="sd">        segment_size: `int`</span>
<span class="sd">            Target for maximum no. of rows per segment, after compaction.</span>
<span class="sd">            If parameter is not provided, library option - &quot;segment_row_size&quot; will be used</span>
<span class="sd">            Note that no. of rows per segment, after compaction, may exceed the target.</span>
<span class="sd">            It is for achieving smallest no. of segment after compaction. Please refer to below example for further explantion.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        VersionedItem</span>
<span class="sd">            Structure containing metadata and version number of the defragmented symbol in the store.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        1002 ErrorCategory.INTERNAL:E_ASSERTION_FAILURE</span>
<span class="sd">            If `is_symbol_fragmented` returns false.</span>
<span class="sd">        2001 ErrorCategory.NORMALIZATION:E_UNIMPLEMENTED_INPUT_TYPE</span>
<span class="sd">            If library option - &quot;bucketize_dynamic&quot; is ON.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; lib.write(&quot;symbol&quot;, pd.DataFrame({&quot;A&quot;: [0]}, index=[pd.Timestamp(0)]))</span>
<span class="sd">        &gt;&gt;&gt; lib.append(&quot;symbol&quot;, pd.DataFrame({&quot;A&quot;: [1, 2]}, index=[pd.Timestamp(1), pd.Timestamp(2)]))</span>
<span class="sd">        &gt;&gt;&gt; lib.append(&quot;symbol&quot;, pd.DataFrame({&quot;A&quot;: [3]}, index=[pd.Timestamp(3)]))</span>
<span class="sd">        &gt;&gt;&gt; lib.read_index(sym)</span>
<span class="sd">                            start_index                     end_index  version_id stream_id          creation_ts          content_hash  index_type  key_type  start_col  end_col  start_row  end_row</span>
<span class="sd">        1970-01-01 00:00:00.000000000 1970-01-01 00:00:00.000000001          20    b&#39;sym&#39;  1678974096622685727   6872717287607530038          84         2          1        2          0        1</span>
<span class="sd">        1970-01-01 00:00:00.000000001 1970-01-01 00:00:00.000000003          21    b&#39;sym&#39;  1678974096931527858  12345256156783683504          84         2          1        2          1        3</span>
<span class="sd">        1970-01-01 00:00:00.000000003 1970-01-01 00:00:00.000000004          22    b&#39;sym&#39;  1678974096970045987   7952936283266921920          84         2          1        2          3        4</span>
<span class="sd">        &gt;&gt;&gt; lib.version_store.defragment_symbol_data(&quot;symbol&quot;, 2)</span>
<span class="sd">        &gt;&gt;&gt; lib.read_index(sym)  # Returns two segments rather than three as a result of the defragmentation operation</span>
<span class="sd">                            start_index                     end_index  version_id stream_id          creation_ts         content_hash  index_type  key_type  start_col  end_col  start_row  end_row</span>
<span class="sd">        1970-01-01 00:00:00.000000000 1970-01-01 00:00:00.000000003          23    b&#39;sym&#39;  1678974097067271451  5576804837479525884          84         2          1        2          0        3</span>
<span class="sd">        1970-01-01 00:00:00.000000003 1970-01-01 00:00:00.000000004          23    b&#39;sym&#39;  1678974097067427062  7952936283266921920          84         2          1        2          3        4</span>

<span class="sd">        Notes</span>
<span class="sd">        ----------</span>
<span class="sd">        Config map setting - SymbolDataCompact.SegmentCount will be replaced by a library setting</span>
<span class="sd">        in the future. This API will allow overriding the setting as well.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lib_cfg</span><span class="o">.</span><span class="n">lib_desc</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">write_options</span><span class="o">.</span><span class="n">bucketize_dynamic</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ArcticNativeNotYetImplemented</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Support for library with &#39;bucketize_dynamic&#39; ON is not implemented yet&quot;</span>
            <span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">version_store</span><span class="o">.</span><span class="n">defragment_symbol_data</span><span class="p">(</span><span class="n">symbol</span><span class="p">,</span> <span class="n">segment_size</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">VersionedItem</span><span class="p">(</span>
            <span class="n">symbol</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">symbol</span><span class="p">,</span>
            <span class="n">library</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_library</span><span class="o">.</span><span class="n">library_path</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
            <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">library</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_library</span>

    <span class="k">def</span> <span class="nf">library_tool</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LibraryTool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">LibraryTool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">library</span><span class="p">())</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Man Group.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>